### Agent Behavior Modification and Error Recovery
link

Hooks within the system can directly modify AI agent behavior and facilitate error recovery, ensuring smoother operations and guiding agents toward task completion. These hooks include mechanisms for enforcing completion of TODO items, reminding agents about optimal tool usage, sanitizing empty messages to prevent API errors, and appending specific recovery instructions to the [`Edit`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L371) tool's output when errors are detected.
The [`todo-continuation-enforcer`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L974) hook, defined in [`src/hooks/todo-continuation-enforcer.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/todo-continuation-enforcer.ts), manages the continuation of incomplete TODO tasks. It monitors session events, tracking session states and initiating a countdown when a session becomes idle with unfinished tasks. If the countdown completes and tasks remain, it injects a continuation prompt, ensuring the AI agent remains focused on outstanding work. This mechanism includes checks for background tasks and agent permissions to prevent inappropriate prompt injections, and it handles abort errors by resetting the continuation logic.
To encourage efficient agent utilization, an agent usage reminder system, implemented in the [`src/hooks/agent-usage-reminder`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/agent-usage-reminder) directory, tracks the use of agent tools within a session. If certain "target" tools (e.g., [`grep`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/index.ts#L72), [`websearch_exa_web_search_exa`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/agents/librarian.ts#L69)) are executed directly without a specialized agent being invoked first, a [`REMINDER_MESSAGE`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/agent-usage-reminder/constants.ts#L29) is appended to the tool's output. This message, detailed in [`src/hooks/agent-usage-reminder/constants.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/agent-usage-reminder/constants.ts), advises on the benefits of using agents and provides examples, guiding the user towards multi-model orchestration. The system maintains persistent session states to manage reminder counts and agent usage across interactions.
For error recovery during code modifications, the [`edit-error-recovery`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/index.ts#L156) hook, located in the [`src/hooks/edit-error-recovery`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/edit-error-recovery) directory, intercepts the output of the [`Edit`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L371) tool. When predefined error patterns, such as "oldString not found" or "oldString and newString must be different", are detected in the output, a [`EDIT_ERROR_REMINDER`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/edit-error-recovery/index.ts#L16) is appended. This reminder, defined in [`src/hooks/edit-error-recovery/index.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/edit-error-recovery/index.ts), provides specific instructions for the AI to rectify its mistake, emphasizing verification of the file's actual state before attempting further edits.
Additionally, to prevent API errors caused by invalid message content, the [`empty-message-sanitizer`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L974) hook, found in [`src/hooks/empty-message-sanitizer/index.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/empty-message-sanitizer/index.ts), operates on chat messages before they are processed. It ensures that all messages, excluding the final assistant message, contain valid content by injecting [`PLACEHOLDER_TEXT`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/session-recovery/index.ts#L246) into empty or otherwise invalid messages. This ensures that only well-formed messages are sent to the underlying APIs.
### User Notifications and Feedback Systems
link

User notifications and feedback are managed through a system of hooks that ensure users are informed about system status, updates, and session activity. This includes automatic update checks with toast messages, background notifications for long-running tasks, and configurable desktop alerts for idle sessions.
Automatic update checking is facilitated by the [`auto-update-checker`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L721) hook, which operates upon session creation. This hook determines if the plugin is running in a local development environment, parses configuration files for plugin entries, retrieves installed and the latest available versions from the npm registry, and can update pinned versions within configuration files. User notifications for these checks are displayed as toast messages, indicating the status of the update, local development mode, or any configuration loading errors. If automatic updates are enabled, the system can invalidate the package cache, update the pinned version in the plugin configuration, and re-install the necessary packages. Key utilities for this process are found in [`src/hooks/auto-update-checker`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/auto-update-checker).
Background notifications are managed through a dedicated hook that integrates with a background agent manager. This system processes background events and uses a configurable [`formatNotification`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/background-notification/types.ts#L4) function to present information about ongoing background tasks to the user, ensuring they are aware of asynchronous operations without requiring constant attention. The core logic for this is located in [`src/hooks/background-notification`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/background-notification).
Session idle notifications provide desktop alerts and sounds when an OpenCode session becomes inactive. The [`session-notification`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L974) hook manages and dispatches these notifications, which are configurable for different operating systems. It monitors session activity, triggering notifications after a specified delay if no activity is detected, and can be configured to skip notifications if there are incomplete tasks. The system utilizes OS-specific commands for displaying notifications and playing sounds, and employs robust state management to prevent duplicate alerts and handle session lifecycle events. This functionality is implemented in [`src/hooks/session-notification.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/session-notification.ts) and supported by utility functions in [`src/hooks/session-notification-utils.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/session-notification-utils.ts) for cross-platform command detection. Additionally, the [`empty-task-response-detector`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L974) hook identifies when a [`Task`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L724) tool execution yields an empty output, replacing it with a standardized warning message to inform the user that a task completed without a substantive result. This hook is defined in [`src/hooks/empty-task-response-detector.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/empty-task-response-detector.ts).
### Context Window Monitoring and Preemptive Compaction
link

The system incorporates mechanisms to actively monitor and manage the context window usage of AI models, particularly focusing on Anthropic's Claude models, to prevent overflows and ensure continuous operation. This involves both injecting reminders about context capabilities and proactively compacting session history when token limits are approached.
One core component, implemented in [`src/hooks/context-window-monitor.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/context-window-monitor.ts), monitors the actual token usage after tool executions. If the session's token count, which reflects the usage post-compaction, exceeds a predefined warning threshold (e.g., 70% of the practical limit), a [`CONTEXT_REMINDER`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/context-window-monitor.ts#L7) message is appended to the tool's output. This serves as a direct prompt to the AI, reminding it of the extensive context window available (e.g., 1 million tokens for Claude) to guide its subsequent actions. This mechanism avoids redundant reminders by tracking sessions that have already been reminded.
Complementing this monitoring, a preemptive compaction hook, primarily defined in [`src/hooks/preemptive-compaction/index.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/preemptive-compaction/index.ts), actively reduces the session's token footprint through summarization. This hook listens for events such as [`message.updated`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/cli/run/events.ts#L95) (after an assistant's response) or [`session.idle`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/cli/run/events.ts#L74) and checks the current token usage ratio against a configurable threshold. If the ratio is exceeded and a minimum token count for compaction is met, the system initiates a summarization process using [`ctx.client.session.summarize`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/preemptive-compaction/index.ts#L168). This condenses the session history, making room for new interactions. To prevent excessive compaction, a cooldown period is enforced, and the system provides user feedback through toasts during the compaction process. The configuration for this mechanism, including the default threshold (85%), minimum tokens required for compaction (50,000), and cooldown duration, is managed by constants defined in [`src/hooks/preemptive-compaction/constants.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/preemptive-compaction/constants.ts). The state of compaction, such as the last compaction time and ongoing operations, is tracked using data structures defined in [`src/hooks/preemptive-compaction/types.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/preemptive-compaction/types.ts). This dual approach of reminding the AI and preemptively compacting ensures efficient context management, especially for large language models. The system also handles model-specific context limits and patterns (e.g., [`CLAUDE_MODEL_PATTERN`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/preemptive-compaction/index.ts#L50)) to ensure that compaction is applied appropriately. This proactive strategy helps maintain conversational flow and prevents interruptions due to context window overflows.
### Keyword Detection and Mode Activation
link

The keyword detection system dynamically identifies specific patterns in chat messages to trigger specialized operational modes, inject contextual information, and modify the chat message flow to guide agent behavior. The system preprocesses incoming messages to remove code blocks, ensuring that keyword detection focuses on natural language. This is achieved by stripping out multiline and inline code segments before analysis in [`src/hooks/keyword-detector/detector.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/keyword-detector/detector.ts).
Predefined keywords are associated with detailed instructional messages and operational guidelines, enabling various modes such as "Ultrathink," "Search," and "Analysis." For instance, "Ultrathink" mode, triggered by keywords like "ultrawork," emphasizes precision, parallel execution of background tasks, continuous verification, and adherence to specific agent utilization principles, as defined in [`src/hooks/keyword-detector/constants.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/keyword-detector/constants.ts). Similarly, "Search" and "Analysis" modes direct the system to perform exhaustive searches or gather context in parallel using specialized agents and tools.
When keywords are detected, the system determines how to inject the associated context. For the first message in a session, the detected keyword context is prepended directly to the message's output parts, which can influence how the message is initially processed or how titles are generated. For subsequent messages, the keyword context is injected as a separate message into the chat session via the [`injectHookMessage`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/hook-message-injector/injector.ts#L69) utility. This approach ensures that additional context is added without altering previous message content. The system also manages session-specific states to prevent redundant actions, such as re-notifying users about mode activations. For example, if "Ultrawork" keywords are detected for the first time in a session, a toast notification is displayed to the user through [`ctx.client.tui.showToast`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/keyword-detector/index.ts#L43). The core logic for this process is encapsulated in the [`createKeywordDetectorHook`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/keyword-detector/index.ts#L13) function within [`src/hooks/keyword-detector/index.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/keyword-detector/index.ts).
### Comment Checker Integration
link

The system integrates an external comment checker CLI tool to analyze code modifications and provide feedback. This integration manages the entire lifecycle of the CLI tool, including its dynamic download, execution, and sophisticated processing of comments.
The [`createCommentCheckerHooks`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/comment-checker/index.ts#L35) function in [`src/hooks/comment-checker/index.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/comment-checker/index.ts) is the primary entry point for this integration. It registers [`tool.execute.before`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/index.ts#L380) and [`tool.execute.after`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/index.ts#L433) hooks to monitor file modification operations. Before a tool like [`write`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-supersede.ts#L146), [`edit`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/agents/oracle.ts#L106), or [`multiedit`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/rules-injector/index.ts#L55) executes, the [`tool.execute.before`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/index.ts#L380) hook captures details of the proposed changes, such as file paths and content, storing them temporarily. After the tool's execution, the [`tool.execute.after`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/index.ts#L433) hook retrieves these stored details and orchestrates the invocation of the [`comment-checker`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/bun.lock#L11) CLI.
The [`comment-checker`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/bun.lock#L11) CLI binary is managed by the utilities in [`src/hooks/comment-checker/cli.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/comment-checker/cli.ts) and [`src/hooks/comment-checker/downloader.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/comment-checker/downloader.ts). This involves locating the binary, and if not found, asynchronously downloading it from GitHub Releases to a local cache. The system supports various platforms and ensures the binary has executable permissions. This lazy downloading approach avoids unnecessary overhead if the checker is not required immediately.
Once executed, the [`comment-checker`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/bun.lock#L11) analyzes the modified code. A key aspect of this analysis is comment filtering, implemented in the [`src/hooks/comment-checker/filters`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/comment-checker/filters) directory. This filtering mechanism, orchestrated by [`applyFilters`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/comment-checker/filters/index.ts#L16) in [`src/hooks/comment-checker/filters/index.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/comment-checker/filters/index.ts), determines which detected comments should be flagged and which should be ignored. For example, comments identified as Behavior-Driven Development (BDD) keywords ([`filterBddComments`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/comment-checker/filters/bdd.ts#L15) in [`src/hooks/comment-checker/filters/bdd.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/comment-checker/filters/bdd.ts)), type checker directives ([`filterDirectiveComments`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/comment-checker/filters/directive.ts#L16) in [`src/hooks/comment-checker/filters/directive.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/comment-checker/filters/directive.ts)), docstrings ([`filterDocstringComments`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/comment-checker/filters/docstring.ts#L3) in [`src/hooks/comment-checker/filters/docstring.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/comment-checker/filters/docstring.ts)), or shebang lines ([`filterShebangComments`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/comment-checker/filters/shebang.ts#L3) in [`src/hooks/comment-checker/filters/shebang.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/comment-checker/filters/shebang.ts)) are typically skipped. These filters normalize comment text and compare it against predefined patterns or keywords, ensuring that only comments requiring attention are reported.
The results from the comment checker, specifically the identified comments that were not filtered out, are then formatted into an XML string by [`buildCommentsXml`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/comment-checker/output/xml-builder.ts#L12) in [`src/hooks/comment-checker/output/xml-builder.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/comment-checker/output/xml-builder.ts). This XML output, along with a header that outlines policies for handling comments and docstrings, is then integrated into the tool's output via [`formatHookMessage`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/comment-checker/output/formatter.ts#L5) in [`src/hooks/comment-checker/output/formatter.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/comment-checker/output/formatter.ts), providing structured feedback to the developer. The [`HOOK_MESSAGE_HEADER`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/comment-checker/constants.ts#L45) constant in [`src/hooks/comment-checker/constants.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/comment-checker/constants.ts) defines the guidelines for developers to address detected comments. The system uses specific types defined in [`src/hooks/comment-checker/types.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/comment-checker/types.ts) to manage comment information, pending calls, and filter results.
