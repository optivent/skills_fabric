### Error Detection and Empty Message Handling
link

The system includes mechanisms to detect and address specific error conditions encountered during AI chat sessions, particularly those related to Anthropic models. A key component, residing in [`src/hooks/anthropic-context-window-limit-recovery/parser.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/parser.ts), is responsible for identifying and parsing various error formats to determine if they signify a token limit overrun or a "non-empty content" issue. This parser differentiates token limit errors from other issues, such as "thinking block" errors, by leveraging regular expressions and keyword matching to extract details like current and maximum token counts.
When a token limit error or an empty content error is detected, the [`executeCompact`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/executor.ts#L270) function within [`src/hooks/anthropic-context-window-limit-recovery/executor.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/executor.ts) orchestrates a recovery process. This process includes specific steps to address "non-empty content" errors, which often occur when messages in the conversation history are empty and prevent summarization. The system attempts to resolve these by modifying the empty messages, either by replacing their text parts or by injecting a [`[user interrupted]`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/session-recovery/index.ts#L246) placeholder text. This ensures that subsequent summarization attempts can proceed without encountering similar errors. The [`ParsedTokenLimitError`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/types.ts#L1) interface, defined in [`src/hooks/anthropic-context-window-limit-recovery/types.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/types.ts), provides a structured representation of these identified errors, including the [`errorType`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/session-recovery/index.ts#L340) field that categorizes the specific nature of the problem, enabling targeted recovery actions. For a comprehensive understanding of the recovery process, refer to [Context Window Limit Recovery](https://codewiki.google/github.com/code-yeongyu/oh-my-opencode#context-window-limit-recovery).
