## Lifecycle Hooks and Behavior Modification
link

The system employs a comprehensive framework of lifecycle hooks to intercept and modify the behavior of AI agents and manage session interactions. These hooks provide dynamic control over various aspects of the system's operation, including context management, agent behavior, user notifications, environment setup, and session recovery. The core of this system is defined within the [`src/hooks`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks) directory, which aggregates and exposes functions for creating various specialized hooks. The overall purpose, structure, events, and integration patterns for hooks are documented in [`src/hooks/AGENTS.md`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/AGENTS.md).
The hook system operates at different lifecycle points, each serving a distinct purpose:
  * **Pre-Tool Use ([`PreToolUse`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/claude-code-hooks/types.ts#L24))**: Hooks triggered before a tool is used, allowing for validation, modification of tool inputs, or even blocking the tool's execution.
  * **Post-Tool Use ([`PostToolUse`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/claude-code-hooks/types.ts#L25))**: Hooks executed after a tool completes, enabling actions like adding context, generating warnings, or injecting messages based on the tool's outcome.
  * **User Prompt Submission ([`UserPromptSubmit`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/claude-code-hooks/types.ts#L26))**: Hooks that intercept and can modify or block user prompts before they are fully processed by the AI.
  * **Pre-Compaction ([`PreCompact`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/claude-code-hooks/types.ts#L28))**: Hooks that run before a session compaction operation, allowing for gathering additional context or preventing the compaction entirely.
  * **Stop ([`Stop`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/claude-code-hooks/types.ts#L27))**: Hooks triggered when a session stops, which can block the stop, provide reasons, or inject follow-up prompts.
  * **On Summarize ([`onSummarize`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/AGENTS.md?plain=1#L45))**: Hooks used specifically during session summarization, primarily for preserving crucial context.

These lifecycle events are managed by a general-purpose framework, detailed in [General Purpose Claude Code Hooks Framework](https://codewiki.google/github.com/code-yeongyu/oh-my-opencode#lifecycle-hooks-and-behavior-modification-general-purpose-claude-code-hooks-framework), which integrates custom logic and configuration at these various points.
Key functionalities implemented through these hooks include:
  * **Dynamic Context Management** : A multi-phase recovery system, described in [Dynamic Context Pruning and Session Summarization](https://codewiki.google/github.com/code-yeongyu/oh-my-opencode#lifecycle-hooks-and-behavior-modification-dynamic-context-pruning-and-session-summarization), dynamically prunes context, aggressively truncates tool outputs, and strategically summarizes sessions to manage token window limits, particularly for Anthropic models. Additionally, context window usage is continuously monitored, and preemptive compaction is triggered as thresholds are approached. See [Context Window Monitoring and Preemptive Compaction](https://codewiki.google/github.com/code-yeongyu/oh-my-opencode#lifecycle-hooks-and-behavior-modification-context-window-monitoring-and-preemptive-compaction) for more details.
  * **Behavioral Control** : Agents' behavior can be directly influenced. For instance, specific keywords in chat messages can activate specialized operational modes or inject contextual information, as outlined in [Keyword Detection and Mode Activation](https://codewiki.google/github.com/code-yeongyu/oh-my-opencode#lifecycle-hooks-and-behavior-modification-keyword-detection-and-mode-activation). Automated processing of slash commands from chat messages is handled by [Automated Slash Command Processing](https://codewiki.google/github.com/code-yeongyu/oh-my-opencode#lifecycle-hooks-and-behavior-modification-automated-slash-command-processing), ensuring commands are executed once and properly handled. The system also supports an iterative workflow management, known as the "Ralph Loop," which guides agents with continuation prompts until completion, as detailed in [Iterative Workflow Management (Ralph Loop)](https://codewiki.google/github.com/code-yeongyu/oh-my-opencode#lifecycle-hooks-and-behavior-modification-iterative-workflow-management-ralph-loop). Furthermore, hooks can enforce TODO completion, remind users about agent usage, sanitize empty messages, and append error recovery reminders to tool outputs, as described in [Agent Behavior Modification and Error Recovery](https://codewiki.google/github.com/code-yeongyu/oh-my-opencode#lifecycle-hooks-and-behavior-modification-agent-behavior-modification-and-error-recovery).
  * **Environment and Session Context Injection** : The system dynamically injects contextual information into AI sessions to enhance decision-making. This includes content from [`src/hooks/directory-agents-injector`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/directory-agents-injector) and [`src/hooks/directory-readme-injector`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/directory-readme-injector) files from parent directories, as well as managing non-interactive shell environments by injecting environment variables to prevent user prompts. This is further elaborated in [Environment and Session Context Injection](https://codewiki.google/github.com/code-yeongyu/oh-my-opencode#lifecycle-hooks-and-behavior-modification-environment-and-session-context-injection). A contextual rules injection system, covered in [Contextual Rules Injection System](https://codewiki.google/github.com/code-yeongyu/oh-my-opencode#lifecycle-hooks-and-behavior-modification-contextual-rules-injection-system), discovers and injects project-specific and user-defined guidance into tool outputs.
  * **Interactive Session Management** : Hooks manage interactive Bash sessions, particularly through [`tmux`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L186), by tracking and controlling sessions, parsing commands, persisting states, cleaning up orphaned sessions, and generating reminders to maintain environmental consistency. This functionality is described in [Management of Interactive Bash Sessions](https://codewiki.google/github.com/code-yeongyu/oh-my-opencode#lifecycle-hooks-and-behavior-modification-management-of-interactive-bash-sessions).
  * **User Notifications and Feedback** : Various hooks are responsible for providing real-time feedback and notifications to the user, including automatic update checks with toast messages, background notifications for task completion, and idle session notifications with desktop alerts and sounds. More details can be found in [User Notifications and Feedback Systems](https://codewiki.google/github.com/code-yeongyu/oh-my-opencode#lifecycle-hooks-and-behavior-modification-user-notifications-and-feedback-systems).
  * **External Tool Integration** : The system integrates external tools, such as a comment checker CLI, managing its lifecycle from download and execution to filtering comments and formatting output for developer feedback. See [Comment Checker Integration](https://codewiki.google/github.com/code-yeongyu/oh-my-opencode#lifecycle-hooks-and-behavior-modification-comment-checker-integration).

### Dynamic Context Pruning and Session Summarization
link

The system includes a multi-phase recovery system designed to manage context window limits, particularly for models like Anthropic's, and to prevent token overflows during AI chat sessions. This system is initiated when [`session.error`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/index.ts#L353) or [`session.idle`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/cli/run/events.ts#L74) events occur, often triggered by token limit errors identified by [`parseAnthropicTokenLimitError`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/parser.ts#L76) in [`src/hooks/anthropic-context-window-limit-recovery/parser.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/parser.ts).
The recovery process, orchestrated by [`executeCompact`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/executor.ts#L270) in [`src/hooks/anthropic-context-window-limit-recovery/executor.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/executor.ts), involves several strategies:
  1. **Dynamic Context Pruning (DCP)** : This phase attempts to reduce token count by identifying and removing redundant information from the conversation history. It employs several sub-strategies:
     * **Deduplication** : Handled by [`executeDeduplication`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-deduplication.ts#L82) in [`src/hooks/anthropic-context-window-limit-recovery/pruning-deduplication.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-deduplication.ts), this identifies and prunes duplicate tool calls based on their unique signature (tool name and sorted input parameters), keeping only the most recent occurrence.
     * **Superseding Writes** : Implemented by [`executeSupersedeWrites`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-supersede.ts#L78) in [`src/hooks/anthropic-context-window-limit-recovery/pruning-supersede.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-supersede.ts), this strategy prunes older [`write`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-supersede.ts#L146) and [`edit`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/agents/oracle.ts#L106) tool calls that have been superseded by later operations on the same file, reducing redundant file system state changes in the context.
     * **Purging Errors** : Managed by [`executePurgeErrors`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-purge-errors.ts#L66) in [`src/hooks/anthropic-context-window-limit-recovery/pruning-purge-errors.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-purge-errors.ts), this removes tool calls that resulted in errors and occurred beyond a configurable number of turns, preventing old, failed operations from consuming context. The results of these pruning actions are applied to the session messages via [`applyPruning`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-storage.ts#L38) in [`src/hooks/anthropic-context-window-limit-recovery/pruning-storage.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-storage.ts), which replaces pruned content with placeholder text and calculates tokens saved.
  2. **Aggressive Tool Output Truncation** : If token limits persist after DCP, [`truncateUntilTargetTokens`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/storage.ts#L184) in [`src/hooks/anthropic-context-window-limit-recovery/storage.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/storage.ts) iteratively shortens large tool outputs until a target token reduction is achieved. This directly modifies stored tool parts to reduce their size within the context window.
  3. **Strategic Session Summarization** : As a fallback, or when "non-empty content" errors are detected (as identified by [`parseAnthropicTokenLimitError`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/parser.ts#L76)), the system attempts to fix empty messages using [`fixEmptyMessages`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/executor.ts#L183) or [`sanitizeEmptyMessagesBeforeSummarize`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/executor.ts#L97) in [`src/hooks/anthropic-context-window-limit-recovery/executor.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/executor.ts) before triggering [`client.session.summarize`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/preemptive-compaction/index.ts#L168). This process aims to condense the session history into a shorter, coherent summary, allowing the conversation to continue within token limits.

The entire recovery mechanism uses an event-driven architecture, maintains session-specific states with [`AutoCompactState`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/types.ts#L26) (defined in [`src/hooks/anthropic-context-window-limit-recovery/types.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/types.ts)), and provides user notifications about the recovery progress and outcomes. The comprehensive suite of type definitions and the token estimation utility in [`src/hooks/anthropic-context-window-limit-recovery/pruning-types.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-types.ts) help in managing the data structures and quantifying the impact of pruning efforts.
### General Purpose Claude Code Hooks Framework
link

The extensible Claude Code hooks system integrates custom logic into the Claude Code assistant workflow at various lifecycle points, enabling fine-grained control and observation of AI agent interactions. This framework supports the injection of custom behaviors at key stages, such as before and after tool usage, during user prompt submissions, prior to session compaction, and upon session termination.
The system defines several [`ClaudeHookEvent`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/claude-code-hooks/types.ts#L6) types, each corresponding to a specific intervention point. [`PreToolUse`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/claude-code-hooks/types.ts#L24) hooks, detailed in [`src/hooks/claude-code-hooks/pre-tool-use.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/claude-code-hooks/pre-tool-use.ts), execute before a tool is used, allowing for permission checks, modification of tool inputs, or injection of system messages. Conversely, [`PostToolUse`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/claude-code-hooks/types.ts#L25) hooks, implemented in [`src/hooks/claude-code-hooks/post-tool-use.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/claude-code-hooks/post-tool-use.ts), run after a tool's execution, providing opportunities to block subsequent actions, add contextual information, or inject warnings. [`UserPromptSubmit`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/claude-code-hooks/types.ts#L26) hooks, as defined in [`src/hooks/claude-code-hooks/user-prompt-submit.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/claude-code-hooks/user-prompt-submit.ts), intercept and can potentially modify or block user prompts before full processing. [`PreCompact`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/claude-code-hooks/types.ts#L28) hooks, in [`src/hooks/claude-code-hooks/pre-compact.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/claude-code-hooks/pre-compact.ts), execute before a session compaction operation, allowing for additional context gathering or even stopping the compaction process. Finally, [`Stop`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/claude-code-hooks/types.ts#L27) hooks, managed by [`src/hooks/claude-code-hooks/stop.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/claude-code-hooks/stop.ts), are triggered during a session stop event, capable of blocking the stop operation or injecting new prompts into the session. The [`createClaudeCodeHooksHook`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/claude-code-hooks/index.ts#L36) function in [`src/hooks/claude-code-hooks/index.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/claude-code-hooks/index.ts) serves as the central integration point for these hooks within the OpenCode plugin system.
The system manages configurations in a layered manner, as described in [Plugin Integration and Configuration Flow](https://codewiki.google/github.com/code-yeongyu/oh-my-opencode#agent-orchestration-and-core-system-plugin-integration-and-configuration-flow). The [`loadClaudeHooksConfig`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/claude-code-hooks/config.ts#L81) function in [`src/hooks/claude-code-hooks/config.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/claude-code-hooks/config.ts) handles the loading, normalization, and merging of hook settings from multiple [`settings.json`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L618) files, prioritizing custom paths, then the global Claude configuration directory, and finally local directories. This layered approach ensures that user-specific and project-specific settings can override or extend default configurations, with the [`mergeHooksConfig`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/claude-code-hooks/config.ts#L61) function appending hooks for the same event types without overwriting. Additionally, [`src/hooks/claude-code-hooks/config-loader.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/claude-code-hooks/config-loader.ts) focuses on loading and managing plugin configurations to selectively disable specific Claude hook commands based on user and project settings, using regular expression matching for flexibility. Default execution settings, such as forcing [`zsh`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/AGENTS.md?plain=1#L9) and its path, are defined in [`src/hooks/claude-code-hooks/plugin-config.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/claude-code-hooks/plugin-config.ts).
To support the functionality of these hooks, several utility modules are provided. Conversation transcripts are managed by [`src/hooks/claude-code-hooks/transcript.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/claude-code-hooks/transcript.ts), which records user, assistant, and tool-related messages, and can build Claude Code-compatible transcripts from session history for contextual analysis by hooks. TODO list management is handled by [`src/hooks/claude-code-hooks/todo.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/claude-code-hooks/todo.ts), enabling the creation, loading, saving, and deletion of session-specific TODO files. [`src/hooks/claude-code-hooks/tool-input-cache.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/claude-code-hooks/tool-input-cache.ts) implements a simple in-memory cache for [`tool_input`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/comment-checker/cli.ts#L133) data, facilitating the transfer of information between [`PreToolUse`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/claude-code-hooks/types.ts#L24) and [`PostToolUse`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/claude-code-hooks/types.ts#L25) contexts. These utilities, along with robust type definitions in [`src/hooks/claude-code-hooks/types.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/claude-code-hooks/types.ts), ensure a structured and flexible environment for extending AI agent behavior.
