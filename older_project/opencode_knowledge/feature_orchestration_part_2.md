### Skill and MCP Configuration Management
link

OpenCode AI agent skills are managed through a system that loads, merges, and defines various functionalities, including their Micro-Agent Compute Protocol (MCP) configurations. Skills are primarily markdown files containing instructions and metadata, which the system parses and utilizes.
The loading process originates from various predefined directories, such as user-specific, project-specific, and global OpenCode paths. The [`loadSkillsFromDir`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/opencode-skill-loader/loader.ts#L123) function in [`src/features/opencode-skill-loader/loader.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/opencode-skill-loader/loader.ts) reads these skill definitions, resolving symbolic links and parsing [`SKILL.md`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L653) files to extract YAML frontmatter for metadata and the main body as an instruction template. Additionally, [`mcp.json`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L592) files within skill directories can define or override MCP configurations.
Once loaded, skills are aggregated and merged into a unified list of [`LoadedSkill`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/opencode-skill-loader/types.ts#L20) objects by the [`mergeSkills`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/opencode-skill-loader/merger.ts#L187) function in [`src/features/opencode-skill-loader/merger.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/opencode-skill-loader/merger.ts). This merging process accounts for different [`SkillScope`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/opencode-skill-loader/types.ts#L4) origins (e.g., [`"builtin"`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/config.ts#L254), [`"config"`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/cli/install.ts#L252), [`"user"`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/config.ts#L51), [`"project"`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/config.ts#L48), [`"opencode"`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/config.ts#L54)) and resolves conflicts based on a defined priority hierarchy, ensuring that project-specific or OpenCode-specific skills take precedence over others. The [`BuiltinSkill`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/builtin-skills/types.ts#L3) objects, such as the [`playwrightSkill`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/builtin-skills/skills.ts#L3) in [`src/features/builtin-skills/skills.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/builtin-skills/skills.ts) for browser automation, are converted into [`LoadedSkill`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/opencode-skill-loader/types.ts#L20) objects during this phase. This allows for both pre-configured and dynamically loaded skills to be managed consistently. For a broader overview of how various features, including skills, are loaded, refer to [Dynamic Feature Loading and Priority](https://codewiki.google/github.com/code-yeongyu/oh-my-opencode#feature-orchestration-dynamic-feature-loading-and-priority).
The [`SkillMcpManager`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/skill-mcp-manager/manager.ts#L14) in [`src/features/skill-mcp-manager/manager.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/skill-mcp-manager/manager.ts) orchestrates interactions with MCP servers. This manager maintains a cache of [`Client`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/session-recovery/index.ts#L24) instances, ensuring a single, active connection for a given session, skill, and server combination. It handles the creation, connection, and disconnection of these clients, utilizing [`StdioClientTransport`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/skill-mcp-manager/manager.ts#L2) for inter-process communication with MCP servers. The manager also provides wrapper methods like [`listTools`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/skill-mcp-manager/manager.ts#L127), [`callTool`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/skill-mcp-manager/manager.ts#L154), and [`readResource`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/skill-mcp-manager/manager.ts#L165) to interact with connected MCP servers, abstracting the underlying communication details. This setup allows skills to specify their required [`mcpConfig`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/opencode-skill-loader/loader.ts#L72) within their definitions, enabling them to leverage external tools or services via the Model Context Protocol.
### Hook Message Injection and Session State
link

The system incorporates a mechanism for injecting synthetic "hook" messages into a session's history, enabling programmatic interaction and contextual modification. These messages are distinct from user-generated input and are used to guide agent behavior, provide context, or manage workflow. The core functionality, primarily implemented in [`src/features/hook-message-injector/injector.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/hook-message-injector/injector.ts), involves the creation of structured message metadata and textual content, which are then persisted to the filesystem.
When a hook message is injected via the [`injectHookMessage`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/hook-message-injector/injector.ts#L69) function, it is assigned unique identifiers for both the message and its constituent parts. The system also resolves relevant agent and model information, often by referencing the context of previous messages if the immediate source lacks these details, using a mechanism in [`findNearestMessageWithFields`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/background-task/tools.ts#L65). This ensures that injected messages maintain proper attribution and context within the conversational flow.
Message metadata, defined by the [`MessageMeta`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/hook-message-injector/types.ts#L1) interface in [`src/features/hook-message-injector/types.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/hook-message-injector/types.ts), includes details such as message ID, session ID, role (e.g., "assistant"), timestamps, and information about the agent and model involved. The actual text content is stored as a [`TextPart`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/hook-message-injector/types.ts#L34), also defined in [`src/features/hook-message-injector/types.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/hook-message-injector/types.ts), which includes the text itself and a [`synthetic`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/session-recovery/storage.ts#L110) flag indicating its programmatic origin. Both the metadata and text parts are written as JSON files to a structured directory system under [`src/features/hook-message-injector/constants.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/hook-message-injector/constants.ts), ensuring persistent storage and retrievability across sessions.
Complementing this, the system manages Claude code session states, as detailed in [`src/features/claude-code-session-state/state.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/claude-code-session-state/state.ts). This includes tracking the main session ID and maintaining a set of subagent session IDs. This state management is crucial for orchestrating multi-agent interactions and ensuring that hook messages are injected within the correct operational context. This allows for a robust and traceable record of both human and programmatic interactions within the AI agent system.
