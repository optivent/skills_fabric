## Language Server Protocol (LSP) Integrations
link

The system integrates Language Server Protocol (LSP) functionalities to provide rich code intelligence features, enabling enhanced interaction with various programming languages and development tools. This integration is designed to be flexible, supporting multiple LSP servers, managing their lifecycle, and exposing their capabilities as callable tools.
At its core, LSP integration involves client management, where the system creates, reuses, and cleans up [`LSPClient`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/client.ts#L189) instances for different projects and language servers. This lifecycle management, primarily handled by [`LSPServerManager`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/client.ts#L15) in [`src/tools/lsp/client.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/client.ts), ensures efficient resource allocation and graceful shutdown. The [`LSPClient`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/client.ts#L189) itself facilitates communication with individual LSP server processes, managing JSON-RPC message exchange for requests, responses, and notifications, and handling server-initiated requests.
Server configurations are managed through a layered approach, allowing definitions from [`oh-my-opencode.json`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L330) files at the project, user, and global [`opencode`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/config.ts#L54) levels. These configurations are merged, with project-level settings taking precedence, to provide a comprehensive list of available LSP servers. The system identifies appropriate servers for specific file extensions and checks for their installation status, as detailed in [`src/tools/lsp/config.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/config.ts). This allows for dynamic server discovery and adaptation to diverse development environments.
The functionalities exposed by LSP servers, such as retrieving hover information, navigating to definitions, finding references, listing document or workspace symbols, fetching diagnostics, and applying code actions (like quick fixes or refactorings), are made available as callable tools. Each tool is defined with a clear description, arguments, and an execution method that interfaces with the LSP client, as shown in [`src/tools/lsp/tools.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/tools.ts). This design abstracts the complexities of LSP communication, presenting code intelligence features as accessible actions within the system. Utility functions, located in [`src/tools/lsp/utils.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/utils.ts), assist in tasks like workspace root detection, URI-to-path conversions, and formatting LSP responses into human-readable strings, further streamlining the integration. The overall structure is aggregated and re-exported through [`src/tools/lsp/index.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/index.ts) for simplified access.
### LSP Client Management and Lifecycle
link

The system manages Language Server Protocol (LSP) client instances to interact with various LSP servers. This management includes creating, caching, and reusing client instances for efficiency, as well as gracefully shutting them down when no longer needed or upon process termination.
A central manager, implemented as a singleton in [`src/tools/lsp/client.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/client.ts), orchestrates these LSP client lifecycles. It maintains a cache of active [`LSPClient`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/client.ts#L189) instances, keyed by project root and server ID, to avoid redundant server instantiations. When a client is requested, the manager first checks if an existing, active client can be reused. If not, a new [`LSPClient`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/client.ts#L189) is created, started, and initialized, which involves launching the LSP server process and establishing communication channels.
The [`LSPClient`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/client.ts#L189) itself handles the low-level details of communicating with a single LSP server. It spawns the server process and manages the exchange of JSON-RPC messages over standard input/output streams. This includes parsing incoming messages from the server's output, managing partial messages, and maintaining a mapping of pending requests to their asynchronous responses, complete with timeout mechanisms. The client also sends LSP notifications and handles certain server-initiated requests, such as configuration queries or capability registrations. LSP capabilities like hovering, go-to definition, finding references, and diagnosing issues are supported through this communication layer. Error handling is integrated, capturing standard error output from the LSP server for debugging and storing diagnostic messages pushed by the server.
To prevent resource exhaustion, the manager periodically cleans up [`LSPClient`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/client.ts#L189) instances that have been idle for a configured duration, stopping and removing them from the cache. Furthermore, it registers listeners for various process termination signals to ensure all active [`LSPClient`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/client.ts#L189) instances are gracefully shut down before the main application exits. This robust management of LSP client instances, from creation and reuse to cleanup and shutdown, underpins the system's ability to provide code intelligence features efficiently.
### Layered LSP Configuration and Server Discovery
link

LSP server configurations are managed through a layered approach, integrating settings from project-specific, user-level, and [`opencode`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/config.ts#L54) default [`oh-my-opencode.json`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L330) files. This hierarchy allows for flexible overrides, with project settings taking precedence over user settings, and user settings over [`opencode`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/config.ts#L54) defaults. Built-in LSP server definitions, specified in [`src/tools/lsp/constants.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/constants.ts), are also incorporated into this merge process.
The system discovers and selects appropriate LSP servers based on a file's extension by first identifying all configured servers that support the given extension. It then checks if the corresponding server executable is installed and accessible in the current environment, searching common system [`PATH`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/config.ts#L137) locations and [`opencode`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/config.ts#L54)-specific directories. This robust installation check, detailed in [`src/tools/lsp/config.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/config.ts), ensures that only executable servers are considered. If a server is configured but not installed, the system can provide installation hints. The mapping between file extensions and language identifiers, defined in [`src/tools/lsp/constants.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/constants.ts), is crucial for accurately identifying the language of a file and subsequently selecting the correct LSP server. Servers can also be explicitly disabled through configuration files.
### Exposing LSP Functionalities as Callable Tools
link
Tool Name | Description  
---|---  
`lsp_hover` | Get type information, documentation, and signature for a symbol at a given position.  
`lsp_goto_definition` | Navigate to the definition of a symbol.  
`lsp_find_references` | Find all usages and references of a symbol across the entire workspace.  
`lsp_document_symbols` | Retrieve a hierarchical outline of all symbols within a specific file.  
`lsp_workspace_symbols` | Search for symbols by name across the entire workspace with fuzzy matching.  
`lsp_diagnostics` | Obtain errors, warnings, and hints from the language server.  
`lsp_servers` | List available Language Server Protocol (LSP) servers and their installation status.  
`lsp_prepare_rename` | Check if a rename operation is valid before executing `lsp_rename`.  
`lsp_rename` | Rename a symbol across the entire workspace and apply the changes to affected files.  
`lsp_code_actions` | Get available quick fixes, refactorings, and source actions (e.g., organize imports).  
`lsp_code_action_resolve` | Resolve and apply a code action obtained from `lsp_code_actions`.  
Language Server Protocol (LSP) functionalities are exposed as callable tools within the system, allowing for programmatic interaction with code intelligence features. This abstraction provides a consistent interface for AI agents or orchestrators to perform actions like symbol lookup, navigation, diagnostics, and code modifications. Each LSP capability, such as retrieving hover information, navigating to definitions, or finding references, is encapsulated as a [`ToolDefinition`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/tools.ts#L1) object in [`src/tools/lsp/tools.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/tools.ts).
These tools leverage a higher-order function, [`withLspClient`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/utils.ts#L83) from [`src/tools/lsp/utils.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/utils.ts), to manage the lifecycle of an LSP client connection. This ensures that a client is correctly acquired, utilized for the LSP operation, and then released, decoupling the tool's execution logic from the specifics of client initialization and management. For operations that can yield extensive results, such as searching for references or document symbols, truncation mechanisms are in place to manage output size and prevent system overload. Error handling is also integrated into each tool's execution to gracefully manage communication failures or processing issues with the LSP server.
Specific LSP functionalities exposed as tools include:
  * **[`lsp_hover`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/tools.ts#L37)**: Retrieves type information and documentation for a symbol.
  * **[`lsp_goto_definition`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/index.ts#L60)**: Navigates to the definition of a symbol.
  * **[`lsp_find_references`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/index.ts#L61)**: Locates all usages of a symbol across the workspace.
  * **[`lsp_document_symbols`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/index.ts#L62)**: Provides a hierarchical outline of symbols within a file.
  * **[`lsp_workspace_symbols`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/index.ts#L63)**: Searches for symbols across the entire workspace.
  * **[`lsp_diagnostics`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/index.ts#L64)**: Fetches errors, warnings, and hints for a given file.
  * **[`lsp_servers`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/index.ts#L65)**: Lists available LSP servers and their installation status.
  * **[`lsp_prepare_rename`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/index.ts#L66)**: Validates a rename operation before execution.
  * **[`lsp_rename`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/index.ts#L67)**: Applies a rename operation across the workspace, modifying affected files.
  * **[`lsp_code_actions`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/index.ts#L68)**: Retrieves quick fixes, refactorings, and source actions for a text range.
  * **[`lsp_code_action_resolve`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/index.ts#L69)**: Resolves and applies a specific[`CodeAction`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/types.ts#L128).

These tools transform raw LSP responses into human-readable strings, facilitating their use within the broader AI agent system. Utility functions within [`src/tools/lsp/utils.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/utils.ts) assist in tasks such as path conversions, error formatting, and applying workspace edits to the file system. For further details on the LSP client management, refer to [LSP Client Management and Lifecycle](https://codewiki.google/github.com/code-yeongyu/oh-my-opencode#language-server-protocol-lsp-integrations-lsp-client-management-and-lifecycle).
### LSP Type Definitions and Utility Functions
link
Interface/Function | Description  
---|---  
`LSPServerConfig` | Defines the configuration for an LSP server, including command, extensions, and environment variables.  
`Position`, `Range`, `Location`, `LocationLink` | Core types for specifying text positions, ranges, and document locations within files.  
`SymbolInfo`, `DocumentSymbol` | Describe symbols found in code, including their name, kind, and location; `DocumentSymbol` supports hierarchical structures.  
`Diagnostic` | Represents a problem detected in a document, with range, severity, code, and message.  
`HoverResult` | Encapsulates the content displayed when hovering over code, supporting various content formats.  
`WorkspaceEdit`, `TextEdit`, `CreateFile`, `RenameFile`, `DeleteFile` | Types for representing changes to the workspace, including text modifications and file system operations.  
`CodeAction`, `Command`, `CodeActionContext` | Define actions that can be performed in the editor, often in response to diagnostics or specific contexts.  
`ServerLookupResult`, `ResolvedServer` | Types used to indicate the outcome of searching for an LSP server and its resolved configuration.  
`withLspClient(filePath, fn)` | A utility function to acquire and manage an LSP client for a given file path, executing a provided callback.  
`format*` functions (e.g., `formatDiagnostic`, `formatWorkspaceEdit`) | A collection of utility functions to convert LSP-related data structures into human-readable string formats for display.  
The definition of TypeScript interfaces provides a structured approach for managing Language Server Protocol (LSP) data, ensuring type safety during message exchange between a client and an LSP server. These definitions, found in [`src/tools/lsp/types.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/types.ts), establish clear contracts for data, reducing the likelihood of errors in LSP operations. Key interfaces include [`LSPServerConfig`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/types.ts#L1) for server configurations, [`Position`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/types.ts#L10) and [`Range`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/types.ts#L15) for specifying locations within documents, [`Diagnostic`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/types.ts#L47) for reporting code issues, [`HoverResult`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/types.ts#L55) for hover tooltips, [`TextEdit`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/types.ts#L71) for text modifications, [`WorkspaceEdit`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/types.ts#L100) for collections of changes, and [`CodeAction`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/types.ts#L128) for suggested refactorings. Specialized types like [`ServerLookupResult`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/types.ts#L145) manage the outcomes of server discovery, indicating whether a server was found, not configured, or not installed.
Beyond type definitions, a collection of utility functions in [`src/tools/lsp/utils.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/utils.ts) assists in path conversions, error formatting, and applying workspace edits to the file system. These utilities facilitate practical interactions with LSP servers. For example, [`findWorkspaceRoot`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/utils.ts#L24) identifies the project's root directory, while [`uriToPath`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/utils.ts#L45) handles conversions between file URIs and local file paths. Functions such as [`formatHoverResult`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/utils.ts#L114), [`formatDiagnostic`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/utils.ts#L181), and [`formatWorkspaceEdit`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/utils.ts#L253) translate LSP responses into human-readable formats. A crucial utility, [`applyWorkspaceEdit`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/utils.ts#L368), manages the application of complex changes to the file system, handling text edits, file creations, renames, and deletions. The [`withLspClient`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/utils.ts#L83) higher-order function encapsulates the process of acquiring, using, and releasing LSP clients, streamlining interactions with server functionalities.
