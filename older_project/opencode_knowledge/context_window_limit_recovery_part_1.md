## Context Window Limit Recovery
link

The system incorporates an automatic context window limit recovery mechanism, particularly designed for Anthropic models, to ensure continuous AI chat sessions despite token limitations. This system detects token limit errors and addresses issues arising from empty messages, utilizing dynamic context pruning, aggressive tool output truncation, and session summarization strategies to manage the conversation context effectively.
The core logic for this recovery is orchestrated by the [`executeCompact`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/executor.ts#L270) function in [`src/hooks/anthropic-context-window-limit-recovery/executor.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/executor.ts), which implements a multi-phase strategy. This function is triggered by various session events, such as [`session.error`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/index.ts#L353) and [`session.idle`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/cli/run/events.ts#L74), as defined in [`src/hooks/anthropic-context-window-limit-recovery/index.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/index.ts). When an Anthropic token limit error is detected, identified through [`parseAnthropicTokenLimitError`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/parser.ts#L76) in [`src/hooks/anthropic-context-window-limit-recovery/parser.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/parser.ts), the system initiates a series of steps to reduce the session's token count.
The first phase involves dynamic context pruning (DCP), which actively reduces context size by identifying and eliminating redundant information. This includes strategies like deduplication, where identical tool calls are identified and all but the most recent are marked for removal, as implemented by [`executeDeduplication`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-deduplication.ts#L82) in [`src/hooks/anthropic-context-window-limit-recovery/pruning-deduplication.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-deduplication.ts). Additionally, the system prunes superseded file write operations, ensuring that only the most relevant or final file states are kept in context. This is managed by [`executeSupersedeWrites`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-supersede.ts#L78) in [`src/hooks/anthropic-context-window-limit-recovery/pruning-supersede.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-supersede.ts), which can operate in aggressive or conservative modes to optimize token savings. Another pruning strategy, [`executePurgeErrors`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-purge-errors.ts#L66) in [`src/hooks/anthropic-context-window-limit-recovery/pruning-purge-errors.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-purge-errors.ts), removes errored tool calls that are older than a configurable number of turns, further optimizing context by discarding irrelevant failures. The [`PruningState`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-types.ts#L32) defined in [`src/hooks/anthropic-context-window-limit-recovery/pruning-types.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-types.ts) is central to accumulating these pruning decisions across different strategies, which are then applied to the session data by [`applyPruning`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-storage.ts#L38) in [`src/hooks/anthropic-context-window-limit-recovery/pruning-storage.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-storage.ts).
If, after dynamic context pruning, the token limit is still exceeded, the system proceeds to aggressive truncation. This involves iteratively shortening large tool outputs until a target token reduction is achieved, managed by [`truncateUntilTargetTokens`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/storage.ts#L184) in [`src/hooks/anthropic-context-window-limit-recovery/storage.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/storage.ts). This step focuses on reducing the size of verbose outputs without removing entire messages, aiming to preserve more context.
The final fallback phase addresses persistent token limit issues or "non-empty content" errors. In such cases, the system attempts to fix empty messages by modifying or injecting placeholder text into them. If errors persist, the session is summarized using [`client.session.summarize`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/preemptive-compaction/index.ts#L168), and an exponential backoff mechanism is employed for retrying summarization attempts. The [`ParsedTokenLimitError`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/types.ts#L1) in [`src/hooks/anthropic-context-window-limit-recovery/parser.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/parser.ts) helps in precisely identifying and understanding the nature of these token limit errors. The overall recovery process is designed to be persistent, managing session-specific retry, truncation, and DCP states through the [`AutoCompactState`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/types.ts#L26) object, which is defined in [`src/hooks/anthropic-context-window-limit-recovery/types.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/types.ts).
### Event-Driven Recovery Orchestration
link

Context window limit recovery for AI chat sessions is managed by an event-driven architecture that responds to various session events. This system, primarily implemented in the [`src/hooks/anthropic-context-window-limit-recovery/index.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/index.ts) file, orchestrates a multi-phase recovery process to prevent token overflows, especially for Anthropic models.
The recovery process is initiated by [`createAnthropicContextWindowLimitRecoveryHook`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/index.ts#L25), which sets up a [`AutoCompactState`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/types.ts#L26) object to manage session-specific states such as pending compactions, error data, retry attempts, truncation states, and dynamic context pruning states. This [`AutoCompactState`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/types.ts#L26) is a central mechanism for tracking the recovery progress across different sessions.
Key events trigger the recovery mechanism:
  * [`session.error`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/index.ts#L353): This event is the primary trigger, particularly when an Anthropic token limit error or a "non-empty content" error occurs. When such an error is detected, the session is marked for pending compaction, error details are stored, and the [`executeCompact`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/executor.ts#L270) function is scheduled to run after a brief delay.
  * [`message.updated`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/cli/run/events.ts#L95): This event monitors updates to assistant messages. If an updated assistant message is identified as containing a token limit error, it also triggers the process to mark the session for pending compaction.
  * [`session.idle`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/cli/run/events.ts#L74): When a session becomes idle and has a pending compaction request, this event triggers the [`executeCompact`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/executor.ts#L270) function to perform the necessary context recovery. A successful compaction is indicated by a summary status, leading to the removal of the session from the pending compaction list.
  * [`session.deleted`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/index.ts#L343): When a session is deleted, all associated recovery states are cleared to maintain system hygiene.

The [`executeCompact`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/executor.ts#L270) function, detailed in [`src/hooks/anthropic-context-window-limit-recovery/executor.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/executor.ts), acts as the orchestrator for the recovery phases. It systematically applies dynamic context pruning, aggressive tool output truncation, and, if necessary, session summarization to reduce token count or fix problematic messages. This phased approach allows the system to apply progressively more aggressive strategies until the context window issue is resolved, or a maximum number of attempts is exhausted. The [`AutoCompactState`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/types.ts#L26) ensures that the recovery for each session is managed independently and persistently across these attempts.
For details on the various strategies employed in this recovery process, refer to [Dynamic Context Pruning Strategies](https://codewiki.google/github.com/code-yeongyu/oh-my-opencode#context-window-limit-recovery-dynamic-context-pruning-strategies), [Aggressive Tool Output Truncation](https://codewiki.google/github.com/code-yeongyu/oh-my-opencode#context-window-limit-recovery-aggressive-tool-output-truncation), and [Error Detection and Empty Message Handling](https://codewiki.google/github.com/code-yeongyu/oh-my-opencode#context-window-limit-recovery-error-detection-and-empty-message-handling).
### Dynamic Context Pruning Strategies
link

Dynamic Context Pruning (DCP) is a multi-strategy system designed to manage and reduce the token count within a session's conversation context, primarily to prevent context window overflows, especially with models like Anthropic's. The overall execution of these strategies is orchestrated by the [`executeDynamicContextPruning`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-executor.ts#L30) function in [`src/hooks/anthropic-context-window-limit-recovery/pruning-executor.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-executor.ts), which coordinates the application of various pruning techniques and provides user notifications about the pruning activity. The system tracks the current state of pruning decisions through a [`PruningState`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-types.ts#L32) object, which accumulates information about tool calls to be pruned, file operations, and errors. The [`PruningResult`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-types.ts#L22) object, defined in [`src/hooks/anthropic-context-window-limit-recovery/pruning-types.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-types.ts), summarizes the outcome of the pruning, including the number of items pruned and the total tokens saved.
One key strategy is **deduplication** , implemented by [`executeDeduplication`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-deduplication.ts#L82) in [`src/hooks/anthropic-context-window-limit-recovery/pruning-deduplication.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-deduplication.ts). This process identifies and prunes redundant tool calls that have identical signatures (tool name and sorted input parameters). By generating a consistent signature for each tool call, the system can detect when the same operation has been performed multiple times, marking all but the most recent occurrence for removal. This ensures that the conversation history does not contain excessive duplicate information, thereby conserving tokens. Tools can be protected from deduplication if they are deemed essential.
Another strategy, **superseding writes** , addresses the token usage from file manipulation operations. The [`executeSupersedeWrites`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-supersede.ts#L78) function in [`src/hooks/anthropic-context-window-limit-recovery/pruning-supersede.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-supersede.ts) prunes older [`write`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-supersede.ts#L146) and [`edit`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/agents/oracle.ts#L106) tool calls when their effects are nullified by subsequent interactions with the same file. For example, if a file is written to multiple times, only the latest write might be relevant. The system offers both aggressive and conservative modes for this pruning, allowing a balance between token savings and retaining context.
Finally, the system includes a mechanism to **purge errored tool calls** , detailed in [`executePurgeErrors`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-purge-errors.ts#L66) in [`src/hooks/anthropic-context-window-limit-recovery/pruning-purge-errors.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-purge-errors.ts). This strategy removes tool calls that resulted in an error, provided they are older than a configurable number of turns. This helps clean up the context from unsuccessful operations that are no longer pertinent to the current task. Like other strategies, certain tools can be protected from this purging.
After these strategies identify which parts of the conversation to prune, the [`applyPruning`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-storage.ts#L38) function in [`src/hooks/anthropic-context-window-limit-recovery/pruning-storage.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-storage.ts) modifies the stored message data. It replaces the input and output fields of the targeted tool calls with placeholder text, effectively reducing their token contribution. The estimated token savings are calculated using [`estimateTokens`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/shared/dynamic-truncator.ts#L33) from [`src/hooks/anthropic-context-window-limit-recovery/pruning-types.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/pruning-types.ts), providing a quantitative measure of the pruning's impact. The overall [Context Window Limit Recovery](https://codewiki.google/github.com/code-yeongyu/oh-my-opencode#context-window-limit-recovery) system leverages these dynamic pruning strategies to proactively manage context size, ensuring efficient operation within the constraints of large language models.
### Aggressive Tool Output Truncation
link

The system employs an aggressive truncation mechanism to manage context window limitations, particularly for large language models like Anthropic's. This process iteratively shortens extensive tool outputs to reduce the overall token count in a conversation, aiming to prevent token overflows and facilitate continued interaction with the AI agent.
The core of this mechanism lies in identifying and modifying stored tool execution results. When a context window limit is approached or exceeded, the system calculates the necessary reduction in characters (derived from token counts). It then prioritizes truncating the largest tool outputs first to achieve the target reduction most efficiently. The [`StoredToolPart`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/session-recovery/types.ts#L27) interface in [`src/hooks/anthropic-context-window-limit-recovery/storage.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/storage.ts) defines the structure for these stored tool execution records, including fields for the original size and a [`truncated`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/grep/cli.ts#L163) flag.
The [`truncateUntilTargetTokens`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/storage.ts#L184) function, also in [`src/hooks/anthropic-context-window-limit-recovery/storage.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/storage.ts), orchestrates this process. It iteratively identifies the largest tool outputs using [`findToolResultsBySize`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/storage.ts#L74) and then modifies them using [`truncateToolResult`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/storage.ts#L112). This modification involves replacing the original output with a [`TRUNCATION_MESSAGE`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/storage.ts#L9), marking the part as truncated, and recording its original size. This in-place modification helps maintain the integrity of the session history while reducing its footprint.
The system's configuration, defined in [`src/hooks/anthropic-context-window-limit-recovery/types.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/types.ts), provides parameters such as [`maxTruncateAttempts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/types.ts#L44), [`minOutputSizeToTruncate`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/types.ts#L45), and [`targetTokenRatio`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/anthropic-context-window-limit-recovery/types.ts#L46) to control the behavior and aggressiveness of this truncation. These settings determine when truncation is triggered and how much context is aimed to be recovered. This aggressive truncation is a key component of the overall [Context Window Limit Recovery](https://codewiki.google/github.com/code-yeongyu/oh-my-opencode#context-window-limit-recovery) strategy, working alongside other mechanisms like dynamic context pruning and session summarization.
