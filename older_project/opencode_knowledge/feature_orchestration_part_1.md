## Feature Orchestration
link

The AI agent system manages its various functionalities, including agents, commands, skills, and Message Context Protocol (MCP) servers, through a robust orchestration layer. This layer is responsible for loading configurations, handling background tasks, and injecting messages to guide agent behavior. The overall architecture is designed to allow for dynamic discovery and integration of features, ensuring a flexible and extensible system.
Feature loaders are integral to this process, responsible for identifying and incorporating components such as commands, skills, agents, MCPs, and plugins from designated paths. A defined loader priority ensures that conflicts arising from multiple definitions are resolved consistently. For instance, [`.opencode/command/`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L651) has precedence over [`~/.config/opencode/command/`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L650), and similarly for skills, agents, and MCPs. This system also allows for granular control over feature loading through configuration toggles, enabling or disabling specific components like MCPs, commands, skills, agents, and hooks via a [`claude_code`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L675) JSON configuration object. More information on the details of feature loading and prioritization can be found in [Dynamic Feature Loading and Priority](https://codewiki.google/github.com/code-yeongyu/oh-my-opencode#feature-orchestration-dynamic-feature-loading-and-priority).
Long-running operations, which are managed as background tasks, are a core part of the system's asynchronous capabilities. These tasks undergo a lifecycle from initiation to completion or cancellation, with continuous monitoring and updates on their progress. The system ensures that parent sessions are notified upon task completion or errors, and includes mechanisms for pruning stale tasks to maintain system efficiency. For a deeper dive into how these tasks are handled, refer to [Background Task Management](https://codewiki.google/github.com/code-yeongyu/oh-my-opencode#feature-orchestration-background-task-management).
The system integrates a variety of built-in commands and skills that provide agents with specific functionalities. Commands such as [`init-deep`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/config/schema.ts#L81) facilitate the generation of project knowledge bases, while [`ralph-loop`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L704) supports an iterative development workflow for AI agents. These commands are defined with clear structures and templates to guide their execution. Skills, which encapsulate specialized knowledge or actions, are also managed within this orchestration framework. For example, the [`playwrightSkill`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/builtin-skills/skills.ts#L3) provides browser automation capabilities. The integration of skills often involves interaction with MCP servers, which provide external services or tools. More details on these functionalities are available in [Built-in Commands and Iterative Development](https://codewiki.google/github.com/code-yeongyu/oh-my-opencode#feature-orchestration-built-in-commands-and-iterative-development) and [Skill and MCP Configuration Management](https://codewiki.google/github.com/code-yeongyu/oh-my-opencode#feature-orchestration-skill-and-mcp-configuration-management).
Furthermore, the system incorporates a mechanism for injecting synthetic messages into the session history, ensuring that agents receive necessary contextual information or instructions without direct user input. These injected messages are structured with unique identifiers, context from relevant agents or models, and are persisted for historical reference. This capability allows the system to guide agent behavior and maintain coherent conversational flow. For more on this, see [Hook Message Injection and Session State](https://codewiki.google/github.com/code-yeongyu/oh-my-opencode#feature-orchestration-hook-message-injection-and-session-state).
### Dynamic Feature Loading and Priority
link

The system dynamically discovers and integrates commands, skills, agents, Message Context Protocol (MCP) servers, and plugins from various predefined paths, with a mechanism for establishing loader priority to resolve conflicts when multiple definitions exist. This dynamic loading capability ensures that the AI agent system can adapt to different environments and user configurations by enabling or disabling specific functionalities.
Feature loaders are responsible for identifying and processing configuration files and Markdown definitions across different scopes (user, project, global, OpenCode-specific). For instance, [`src/features/claude-code-agent-loader`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/claude-code-agent-loader) handles loading agents from [`~/.claude/agents/*.md`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L658) for user-specific configurations and project-specific agents. Similarly, [`src/features/claude-code-command-loader`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/claude-code-command-loader) loads command definitions from Markdown files, parsing frontmatter for metadata and using the file body as a template. MCP configurations are managed by [`src/features/claude-code-mcp-loader`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/claude-code-mcp-loader), which loads [`.mcp.json`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L661) files and supports environment variable expansion. Plugins are loaded and managed by [`src/features/claude-code-plugin-loader`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/claude-code-plugin-loader), which orchestrates the discovery of installed plugins and the loading of their components, including commands, skills, agents, and MCP servers. OpenCode skills are handled by [`src/features/opencode-skill-loader`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/opencode-skill-loader), which aggregates skills from various sources and resolves conflicts based on priority.
A defined loader priority order dictates how these different loaders interact and how conflicts are resolved when multiple definitions for the same command, skill, agent, or MCP exist. As detailed in [`src/features/AGENTS.md`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/AGENTS.md), this hierarchy ensures predictable behavior: for commands, [`.opencode/command/`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L651) has the highest priority, followed by [`~/.config/opencode/command/`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L650), then [`.claude/commands/`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L649), and finally [`~/.claude/commands/`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L648). Similar priority structures exist for skills, agents, and MCPs. This system allows for overriding default behaviors or extending functionalities based on the project or user context.
The system also incorporates a [`claude_code`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L675) JSON configuration object that provides granular control over feature loading. This configuration allows for enabling or disabling the loading of specific features such as [`mcp`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/opencode-skill-loader/types.ts#L17), [`commands`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/slashcommand/tools.ts#L17), [`skills`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/agents/sisyphus.ts#L482), [`agents`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L809), and [`hooks`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L964) through boolean toggles. This mechanism, outlined in [`src/features/AGENTS.md`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/AGENTS.md), ensures that only relevant features are loaded, optimizing resource usage and tailoring the AI agent's capabilities to specific requirements.
### Background Task Management
link

The system manages the lifecycle and state of long-running background tasks initiated by AI agents. This involves their initiation, tracking of progress, completion, cancellation, and providing notifications to the parent sessions. A polling mechanism is also employed to monitor their status.
The [`BackgroundManager`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/background-agent/manager.ts#L57) class, defined in [`src/features/background-agent/manager.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/background-agent/manager.ts), is responsible for orchestrating these tasks. When an agent needs to perform a long-running operation, the [`launch`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/cli/AGENTS.md?plain=1#L30) method is used to create a new session for the background task, store its metadata, and send an initial prompt. The system tracks these tasks using [`BackgroundTask`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/background-agent/types.ts#L15) objects, which contain metadata such as [`id`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/cli/run/types.ts#L18), [`sessionID`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/index.ts#L354), [`parentSessionID`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/background-agent/manager.ts#L93), [`description`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/skill/tools.ts#L129), [`status`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/cli/install.ts#L27), and [`progress`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/cli/install.ts#L72). These task definitions are detailed in [`src/features/background-agent/types.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/background-agent/types.ts).
The manager processes system events, such as [`message.part.updated`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/cli/run/events.ts#L81) for progress updates, [`session.idle`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/cli/run/events.ts#L74) for task completion, and [`session.deleted`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/index.ts#L343) for cancellation, to update the task's status. To ensure tasks do not run indefinitely or consume excessive resources, a polling mechanism ([`pollRunningTasks`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/background-agent/manager.ts#L290)) periodically checks the status of running tasks and prunes stale ones after a defined time-to-live ([`TASK_TTL_MS`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/background-agent/manager.ts#L15)).
Upon completion or error, the [`notifyParentSession`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/background-agent/manager.ts#L135) method informs the original parent session about the background task's outcome, potentially displaying a toast notification. The system also handles the cleanup of tasks and notifications to maintain system efficiency. For a broader understanding of how features, including background agents, are dynamically loaded and prioritized, refer to [Dynamic Feature Loading and Priority](https://codewiki.google/github.com/code-yeongyu/oh-my-opencode#feature-orchestration-dynamic-feature-loading-and-priority).
### Built-in Commands and Iterative Development
link

The system includes several built-in commands crucial for both project documentation and managing iterative development. These commands are defined within the [`BUILTIN_COMMAND_DEFINITIONS`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/builtin-commands/commands.ts#L6) in [`src/features/builtin-commands/commands.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/builtin-commands/commands.ts) and are loaded via [`loadBuiltinCommands`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/builtin-commands/commands.ts#L37), which allows for selective activation or deactivation of commands.
One such command is [`init-deep`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/config/schema.ts#L81), designed for generating hierarchical [`AGENTS.md`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L552) files that serve as project knowledge bases. This process, detailed in the [`INIT_DEEP_TEMPLATE`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/builtin-commands/templates/init-deep.ts#L1) in [`src/features/builtin-commands/templates/init-deep.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/builtin-commands/templates/init-deep.ts), involves four phases. Initially, it performs a concurrent "Discovery + Analysis" by spawning [`explore`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/agents/utils.ts#L19) agents, conducting bash structural analysis, reading existing [`AGENTS.md`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L552) files to preserve context, and leveraging Language Server Protocol (LSP) for code mapping. If LSP is unavailable, it falls back to [`AST-grep`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L727) for analysis. The subsequent "Scoring & Location Decision" phase evaluates directories based on factors like file count, code ratio, and symbol density to determine optimal placement for [`AGENTS.md`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L552) files, ensuring the root directory always receives one. The "Generate AGENTS.md" phase then creates these files, with the root containing comprehensive sections and subdirectories receiving concise, context-specific [`AGENTS.md`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L552) files generated by a [`document-writer`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L337) agent as a [`background_task`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/agents/oracle.ts#L106). Finally, the "Review & Deduplicate" phase refines the generated content, removing generic or redundant information. The design prioritizes concurrency, dynamic agent spawning based on project complexity, and hierarchical generation with strict quality control.
Another key command is [`ralph-loop`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L704), which manages an iterative development process for AI agents. The [`RALPH_LOOP_TEMPLATE`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/builtin-commands/templates/ralph-loop.ts#L1) in [`src/features/builtin-commands/templates/ralph-loop.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/builtin-commands/templates/ralph-loop.ts) outlines a continuous cycle where an agent works on a task until a [`<promise>`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/ralph-loop/constants.ts#L3) tag signifies completion. The loop continues with injected prompts if the promise is not met, but it can be configured with a maximum number of iterations or explicitly cancelled by the user using the [`/cancel-ralph`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L707) command. The corresponding [`CANCEL_RALPH_TEMPLATE`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/features/builtin-commands/templates/ralph-loop.ts#L31) provides instructions for stopping an active [`ralph-loop`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L704), clearing its state, and allowing the session to conclude. This iterative workflow is further supported by the [Iterative Workflow Management (Ralph Loop)](https://codewiki.google/github.com/code-yeongyu/oh-my-opencode#lifecycle-hooks-and-behavior-modification-iterative-workflow-management-ralph-loop) hook, which handles state persistence and continuation prompts.
