## Google Antigravity OAuth 2.0 Integration
link

The system integrates Google Antigravity OAuth 2.0 with Proof Key for Code Exchange (PKCE) to facilitate the use of Gemini models. This integration manages the complete authentication lifecycle, from user authorization to token management, project context fetching, and the necessary transformations for communication between OpenAI-compatible requests and Google's Antigravity API.
The authentication process begins with an OAuth 2.0 flow using PKCE, which enhances security by mitigating authorization code interception attacks. A local callback server is used to handle the OAuth redirect, ensuring a streamlined user experience within CLI or desktop environments. Once authorized, access and refresh tokens are securely obtained and managed, with mechanisms for persisting, refreshing, and automatically retrying requests when tokens expire or become invalid. The system dynamically fetches and caches the Google Cloud Platform (GCP) project context, using the Antigravity [`loadCodeAssist`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/fetch.ts#L433) API to retrieve project IDs and onboarding free-tier users through the [`onboardUser`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/project.ts#L4) API. In cases where a project ID is not explicitly provided, a default project ID serves as a fallback.
Communication with Gemini models via the Antigravity API requires a transformation layer. Outgoing requests, initially in an OpenAI-compatible format, are converted to the Antigravity API's expected structure. This involves rewriting URLs to target specific Antigravity endpoints, constructing appropriate HTTP headers, and wrapping request bodies. A key aspect of this transformation is the injection of a [`thoughtSignature`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/fetch.ts#L117) into function call parts within the request body, which can be essential for downstream validation or tracking.
Conversely, responses from the Antigravity/Gemini API are transformed back into an OpenAI-compatible format. This process handles both standard HTTP responses and Server-Sent Events (SSE) streaming responses, extracting usage metadata (such as token counts) from Antigravity-specific headers and error messages, including [`retry-after`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/response.ts#L8) delays. During this response transformation, specific "thinking" blocks, enclosed in [`<antThinking>`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/AGENTS.md?plain=1#L32) tags within Gemini model outputs, are extracted and processed for integration into the OpenAI-compatible output. This ensures that the model's internal reasoning steps are captured while maintaining compatibility with the expected response structure.
All network requests are handled by a custom [`fetch`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/fetch.ts#L487) function that acts as an interceptor. This interceptor is responsible for managing token refreshing, URL rewriting, request and response transformations, endpoint fallback logic (iterating through a list of predefined Antigravity endpoints), and implementing retry mechanisms for transient errors. The entire Antigravity authentication system is integrated into OpenCode as a plugin, providing an [`authHook`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/plugin.ts#L83) that supplies this custom [`fetch`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/fetch.ts#L487) function and orchestrates the OAuth authorization flow.
### OAuth 2.0 Flow with PKCE and Token Management
link

The Antigravity OAuth 2.0 implementation leverages the Proof Key for Code Exchange (PKCE) flow to secure the authentication process for Google services. This flow begins with generating a PKCE [`verifier`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/plugin.ts#L205) and [`challenge`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/oauth.ts#L29) pair, which enhances security by preventing authorization code interception attacks. An authorization URL is then constructed using these PKCE components, along with other necessary parameters like client ID and scopes, as defined in [`src/auth/antigravity/constants.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/constants.ts). This URL initiates the Google OAuth authentication process.
Upon successful user authentication, Google redirects back to a local callback server, typically running on a temporary port, as managed by the functions within [`src/auth/antigravity/oauth.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/oauth.ts). This server receives the authorization [`code`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/utils.ts#L186) and [`state`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/cli/run/events.ts#L87) from Google. The [`state`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/cli/run/events.ts#L87) parameter, which is encoded to include the PKCE [`verifier`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/plugin.ts#L205) and an optional project identifier, is then decoded and validated to ensure the integrity and authenticity of the response.
Following the validation, the authorization [`code`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/lsp/utils.ts#L186) is exchanged for access and refresh tokens by making a request to Google's token endpoint. This exchange uses the PKCE [`verifier`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/plugin.ts#L205) to confirm that the client requesting the tokens is the same one that initiated the authorization flow. Once tokens are acquired, user information, such as email and profile details, can be fetched from Google's userinfo endpoint.
Token management is a critical aspect, handled by the utilities in [`src/auth/antigravity/token.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/token.ts). Access tokens have a limited lifespan, and their expiration is proactively managed by checking if a token is nearing expiry, considering a configurable refresh buffer. When an access token expires or is about to expire, a refresh token is used to obtain a new access token without requiring the user to re-authenticate. This refresh process incorporates robust retry mechanisms with exponential backoff for transient errors, ensuring resilience against temporary network issues or server unavailability. Errors during token refresh, particularly [`invalid_grant`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/fetch.ts#L419) errors, are specifically handled to indicate permanently invalid tokens. The types and interfaces for these tokens and associated errors are defined in [`src/auth/antigravity/types.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/types.ts). Persistent storage of refresh tokens and project context is also managed, allowing for seamless re-authentication across sessions.
### Request and Response Transformation for OpenAI-Gemini Compatibility
link

The system manages the conversion of API requests and responses between the OpenAI format and the Antigravity/Gemini format, enabling interoperability between systems designed for different model providers. This transformation is critical for integrating Google's Gemini models while maintaining compatibility with an OpenAI-centric ecosystem.
For outgoing requests, the [`transformRequest`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/request.ts#L252) function in [`src/auth/antigravity/request.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/request.ts) converts OpenAI-style requests into the Antigravity API's expected structure. This involves dynamically building Antigravity-specific URLs and HTTP headers, and wrapping the original request body to include necessary metadata like [`projectId`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/fetch.ts#L117), [`model`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/agents/utils.ts#L102), and [`requestId`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/types.ts#L90). A key aspect of this transformation is the injection of a [`thoughtSignature`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/fetch.ts#L117) into [`functionCall`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/fetch.ts#L227) objects within the request body. This signature, which defaults to [`SKIP_THOUGHT_SIGNATURE_VALIDATOR`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/constants.ts#L74) if not explicitly provided, is crucial for downstream validation or tracking by the Antigravity API. The request transformation also handles the conversion of OpenAI messages and content parts into Gemini-compatible [`GeminiContent`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/message-converter.ts#L58) and [`GeminiPart`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/thinking.ts#L31) objects, processing system, user, assistant, and tool messages, and converting image URLs into [`inlineData`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/message-converter.ts#L50) parts. Tool definitions are also normalized from OpenAI's [`OpenAITool`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/tools.ts#L17) format to Gemini's [`functionDeclarations`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/tools.ts#L96) using [`normalizeToolsForGemini`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/tools.ts#L89) in [`src/auth/antigravity/tools.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/tools.ts), ensuring that function calls are correctly formatted for the Gemini model.
For incoming responses, the system transforms Antigravity/Gemini API responses back into an OpenAI-compatible format. The [`transformResponse`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/response.ts#L214) function in [`src/auth/antigravity/response.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/response.ts) handles non-streaming responses, unwrapping nested [`response`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/grep/downloader.ts#L44) fields from the Antigravity structure. It also extracts usage metadata from custom [`x-antigravity-*`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/response.ts#L9) headers and processes error responses, including extracting [`retry-after`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/response.ts#L8) delays. For streaming responses, a [`TransformStream`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/response.ts#L342) is created using [`createSseTransformStream`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/response.ts#L342) in [`src/auth/antigravity/response.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/response.ts) to process Server-Sent Events (SSE) incrementally. This stream buffers incoming chunks, decodes them, and processes each complete [`data:`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/shared/frontmatter.ts#L4) line by unwrapping the [`response`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/grep/downloader.ts#L44) field within its JSON payload to align with OpenAI's direct content structure. Similar to requests, tool call results received from Gemini models are converted into OpenAI [`tool_call`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/tools.ts#L136) objects, generating unique IDs and stringifying arguments as needed. The system also extracts [`thoughtSignature`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/fetch.ts#L117) and usage metadata from SSE payloads to maintain consistency.
### Project Context and Thinking Block Management
link

The Antigravity system manages Google Cloud Platform (GCP) project contexts, which are crucial for integrating with Gemini and Duet AI models. This involves dynamically determining the appropriate GCP project ID for API requests and orchestrating user onboarding for FREE tier users. The [`fetchProjectContext`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/fetch.ts#L21) function in [`src/auth/antigravity/project.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/project.ts) retrieves the project context, first by checking a cache, then by calling the [`loadCodeAssist`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/fetch.ts#L433) API to get initial project information. If a project ID is not directly available or if the user is on a FREE tier, the system employs the [`onboardManagedProject`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/project.ts#L114) function to provision a server-managed project ID via the [`onboardUser`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/project.ts#L4) API, which includes retry mechanisms to handle asynchronous onboarding.
Alongside project context management, the system extracts and transforms "thinking" or "reasoning" blocks from Gemini model responses. This process ensures compatibility with systems expecting OpenAI-formatted output. The [`extractThinkingBlocks`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/thinking.ts#L208) function in [`src/auth/antigravity/thinking.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/thinking.ts) parses Gemini API responses, identifying and extracting thinking content, which is then formatted into a standardized [`type: "reasoning"`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/agents/oracle.ts#L33) block by [`formatThinkingForOpenAI`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/thinking.ts#L289). The system also identifies models capable of producing thinking blocks using [`isThinkingCapableModel`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/thinking.ts#L138).
For multi-turn conversations, especially with models like "Gemini 3 Pro" that require [`thought_signature`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/fetch.ts#L226) on function call content blocks, the system manages these signatures and session IDs. The [`thought-signature-store.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/AGENTS.md?plain=1#L18) file in [`src/auth/antigravity/thought-signature-store.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/thought-signature-store.ts) provides an in-memory mechanism to store, retrieve, and clear [`thought_signature`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/fetch.ts#L226) values and session IDs, indexed by a [`sessionKey`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/thought-signature-store.ts#L28) or [`fetchInstanceId`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/fetch.ts#L357). This ensures continuity and proper attribution of thought processes across different interactions. The [`getOrCreateSessionId`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/thought-signature-store.ts#L63) function is used to either retrieve an existing session ID or generate a new one, maintaining consistent session context.
### Interception and Plugin Integration
link

The Antigravity OAuth 2.0 system is integrated into OpenCode as a plugin, leveraging a custom [`fetch`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/fetch.ts#L487) function, [`createAntigravityFetch`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/fetch.ts#L348) in [`src/auth/antigravity/fetch.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/fetch.ts), to comprehensively intercept network requests. This custom [`fetch`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/fetch.ts#L487) manages authentication tokens by refreshing them upon expiration or a 401 Unauthorized response, ensuring continuous access to Google APIs. It also performs URL rewriting to target appropriate Antigravity endpoints and transforms request bodies, for instance, converting OpenAI message formats to Gemini formats and normalizing tool definitions.
The interceptor also handles response transformations, including extracting "thinking" blocks from Gemini responses and adapting them for OpenAI compatibility. To enhance resilience, it implements an endpoint fallback mechanism, iterating through predefined Antigravity endpoints until a successful connection is established. Retry logic is built in for transient errors (e.g., 5xx, 429 status codes) and specific 403 errors, utilizing exponential backoff for GCP permission issues. Project context, including the GCP project ID, is fetched and cached, and debug logging can be enabled for troubleshooting. The entire Antigravity authentication system is enabled through the [`createGoogleAntigravityAuthPlugin`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/plugin.ts#L74) in [`src/auth/antigravity/plugin.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/plugin.ts), which sets up the [`authHook`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/auth/antigravity/plugin.ts#L83) to manage the OAuth flow, including starting a local callback server, building authorization URLs, and exchanging codes for tokens, thereby providing a secure and robust authentication layer within OpenCode. For more details on the OAuth flow, see [OAuth 2.0 Flow with PKCE and Token Management](https://codewiki.google/github.com/code-yeongyu/oh-my-opencode#google-antigravity-oauth-20-integration-oauth-20-flow-with-pkce-and-token-management).
