### Automated Slash Command Processing
link

The auto-slash command hook facilitates the detection, parsing, and execution of slash commands directly from chat messages, streamlining user interaction by automating responses or actions. This system ensures that commands are processed once and handled appropriately within the chat context, enhancing the agent's ability to interpret and respond to user directives.
The process begins with the identification of potential slash commands within a user's prompt. The system first sanitizes the input by removing code blocks, preventing commands embedded in code examples from being misinterpreted. It then parses the remaining text to extract the command name and its arguments, using a defined regular expression for pattern matching. A crucial step involves checking against a list of [`EXCLUDED_COMMANDS`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/auto-slash-command/constants.ts#L8) defined in [`src/hooks/auto-slash-command/constants.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/auto-slash-command/constants.ts), ensuring that specific commands (e.g., [`/ralph-loop`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L704), [`/cancel-ralph`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L707)) are intentionally ignored by this automatic processing mechanism. This detection logic is primarily encapsulated within [`src/hooks/auto-slash-command/detector.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/auto-slash-command/detector.ts).
Once a valid and non-excluded slash command is detected, the system proceeds to its execution. This involves discovering commands from various sources, including user-defined, project-specific, and global configurations, as well as those defined as skills. Commands are structured using Markdown files with frontmatter containing metadata such as description, argument hints, and associated agents or models. This metadata allows for rich command definitions. The command execution component, located in [`src/hooks/auto-slash-command/executor.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/auto-slash-command/executor.ts), then generates a formatted output based on the command's template, which can include dynamic content resolution such as file references or nested command calls.
To prevent redundant processing of the same command within a session, the hook maintains a record of processed commands. If a command has already been handled, it is skipped. The output of the executed command, or an informative error message if execution fails, replaces the original message content within the chat, wrapped in specific tags ([`AUTO_SLASH_COMMAND_TAG_OPEN`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/auto-slash-command/constants.ts#L3) and [`AUTO_SLASH_COMMAND_TAG_CLOSE`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/auto-slash-command/constants.ts#L4) from [`src/hooks/auto-slash-command/constants.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/auto-slash-command/constants.ts)) to indicate that it has been automatically processed. This ensures clear communication to the user and prevents re-triggering of the same command. The overall integration and processing logic reside in [`src/hooks/auto-slash-command/index.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/auto-slash-command/index.ts).
### Management of Interactive Bash Sessions
link

Interactive Bash session management focuses on tracking and controlling [`tmux`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L186) sessions initiated by AI agents. This system is implemented as a plugin hook, which monitors the execution of [`interactive_bash`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/interactive-bash/tools.ts#L50) tool calls. Its primary goal is to ensure that [`tmux`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L186) sessions are properly managed throughout the lifecycle of an AI agent's task, preventing orphaned processes and maintaining a consistent environment.
The system parses [`tmux`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L186) commands, such as [`new-session`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/interactive-bash-session/index.ts#L92), [`kill-session`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/interactive-bash-session/index.ts#L174), and [`kill-server`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/interactive-bash-session/index.ts#L211), to identify and track relevant [`tmux`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L186) sessions. These sessions are prefixed with [`omo-`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/interactive-bash/constants.ts#L14) to distinguish them as being managed by the system. State information about these sessions, including their names and last update times, is stored and retrieved from persistent JSON files, ensuring continuity even if the main application restarts.
A key aspect of this management is the cleanup of [`tmux`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L186) sessions. When a top-level AI session is deleted, the system automatically terminates all associated [`omo-`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/interactive-bash/constants.ts#L14) prefixed [`tmux`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L186) sessions that were created within that context. This prevents [`tmux`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L186) server processes from lingering unnecessarily. Additionally, after an agent performs a [`tmux`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L186) operation, the system provides a reminder message listing all currently active [`omo-`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/interactive-bash/constants.ts#L14) [`tmux`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L186) sessions, offering real-time feedback on the operational environment. Type definitions, such as [`InteractiveBashSessionState`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/interactive-bash-session/types.ts#L1) and [`SerializedInteractiveBashSessionState`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/interactive-bash-session/types.ts#L7) in [`src/hooks/interactive-bash-session/types.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/interactive-bash-session/types.ts), ensure that session data is consistently structured both in memory and during serialization for storage.
### Contextual Rules Injection System
link

This subsection explains the mechanism for dynamically discovering, parsing, and injecting contextual rule files into tool outputs, ensuring that the AI receives relevant project-specific and user-defined guidance while preventing duplicates and managing content truncation. The core logic resides in the [`src/hooks/rules-injector`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/rules-injector) directory.
The system identifies and injects contextual rule files into tool outputs within an AI code assistant environment. This process involves dynamically discovering project-specific and user-defined rules, parsing their metadata, and conditionally applying them to relevant files. This process also ensures that rules are not duplicated and content is truncated appropriately.
Rule discovery is managed by the [`finder`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/rules-injector/index.ts#L5) module, primarily through [`findProjectRoot`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/rules-injector/finder.ts#L36) and [`findRuleFiles`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/rules-injector/finder.ts#L168) in [`src/hooks/rules-injector/finder.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/rules-injector/finder.ts). This identifies the project's root directory and locates rule files in various locations, including project-specific subdirectories and user-specific global directories. The [`calculateDistance`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/rules-injector/finder.ts#L112) function, also in [`src/hooks/rules-injector/finder.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/rules-injector/finder.ts), prioritizes rules based on their proximity to the [`currentFile`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/rules-injector/finder.test.ts#L39). Symbolic links are resolved by [`safeRealpathSync`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/rules-injector/finder.ts#L95) to prevent redundant processing.
Once potential rule files are found, the [`parser`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/bun.lock#L19) module, specifically [`parseRuleFrontmatter`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/rules-injector/parser.ts#L20) in [`src/hooks/rules-injector/parser.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/rules-injector/parser.ts), extracts YAML frontmatter from the rule file content. This frontmatter contains metadata such as [`description`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/skill/tools.ts#L129), [`alwaysApply`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/rules-injector/types.ts#L10), and glob patterns ([`globs`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/rules-injector/matcher.ts#L23), [`paths`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/grep/cli.ts#L143), or [`applyTo`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/rules-injector/types.ts#L3)) that define how and when the rule should be applied. The parsing logic is custom-implemented to handle various YAML formats for lists and strings without external dependencies.
The [`matcher`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/claude-code-hooks/pre-compact.ts#L50) module, detailed in [`src/hooks/rules-injector/matcher.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/rules-injector/matcher.ts), determines if a rule is applicable to a specific file using [`shouldApplyRule`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/rules-injector/matcher.ts#L14) and prevents duplicate injections using [`isDuplicateByRealPath`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/rules-injector/matcher.ts#L47) and [`isDuplicateByContentHash`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/rules-injector/matcher.ts#L61). The [`createContentHash`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/rules-injector/matcher.ts#L54) function generates SHA-256 hashes for content-based deduplication.
Session-specific caching and persistence are handled by the [`storage`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/tools/session-manager/storage.test.ts#L31) module in [`src/hooks/rules-injector/storage.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/rules-injector/storage.ts). Functions like [`loadInjectedRules`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/rules-injector/storage.ts#L16), [`saveInjectedRules`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/rules-injector/storage.ts#L36), and [`clearInjectedRules`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/rules-injector/storage.ts#L54) manage the storage of injected rule data, including content hashes and real paths, for each session. This ensures that rules are not repeatedly injected and maintains state across session interactions.
The overall framework uses an event-driven architecture with hooks for [`tool.execute.before`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/index.ts#L380), [`tool.execute.after`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/index.ts#L433), and [`event`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/index.ts#L331) lifecycle events, allowing the system to react to specific operations and inject rules contextually. Content truncation is managed by [`createDynamicTruncator`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/shared/dynamic-truncator.ts#L173) to keep the injected content within token limits, providing a notice if truncation occurs. For more details on managing context window limits, refer to [Context Window Limit Recovery](https://codewiki.google/github.com/code-yeongyu/oh-my-opencode#context-window-limit-recovery).
### Iterative Workflow Management (Ralph Loop)
link

The "Ralph Loop" functionality provides an iterative workflow for AI agents, enabling them to tackle complex, multi-step tasks by continually receiving guidance and prompts. This loop guides an agent through a series of actions until a predefined completion condition is met or a maximum number of iterations is reached.
The core of the Ralph Loop is its ability to manage state and progress across multiple interactions. When an iterative task begins, a [`RalphLoopState`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/ralph-loop/types.ts#L3) is initialized, capturing details such as the current iteration, the maximum allowed iterations, a completion promise (a specific string or pattern indicating task completion), and the initial prompt given to the agent. This state is persisted, allowing the loop to maintain continuity even if the application restarts or the session is temporarily interrupted.
The loop operates by monitoring agent session events. Primarily, when an agent reaches an "idle" state, the system checks for task completion. This check can involve scanning the agent's recent messages for the specified completion promise or examining a designated transcript file. If the task is not yet complete and the iteration limit has not been exceeded, the system automatically increments the iteration count. A [`CONTINUATION_PROMPT`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/ralph-loop/index.ts#L32) is then dynamically constructed and injected into the agent's session, reminding the agent of its current objective, the remaining iterations, and the desired completion condition, effectively guiding it to the next step of the task.
The loop can be explicitly cancelled or will naturally conclude when either the completion promise is detected or the maximum iteration limit is reached. Upon completion, the loop's state is cleared, and appropriate notifications are provided to the user. This iterative management allows complex development tasks to be broken down into manageable phases, with the system providing consistent oversight and guidance to the AI agent.
For more details on the built-in commands that leverage this iterative process, see [Built-in Commands and Iterative Development](https://codewiki.google/github.com/code-yeongyu/oh-my-opencode#feature-orchestration-built-in-commands-and-iterative-development).
### Environment and Session Context Injection
link

Various hooks within the system are responsible for injecting contextual information into AI sessions to enhance their understanding and guide their behavior. This includes providing project-specific documentation and managing the shell environment to prevent interactive prompts.
The system incorporates hooks to inject content from [`AGENTS.md`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L552) and [`README.md`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L45) files located in parent directories into tool outputs. This process provides the AI agent with project-specific knowledge, such as agent definitions from [`AGENTS.md`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L552) files or general project documentation from [`README.md`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L45) files, relevant to the file paths being processed. Caching mechanisms are employed to prevent redundant injections, and dynamic truncation ensures that the injected content fits within the AI's context window. Persistent storage helps maintain the state of injected paths across sessions. The [`createDirectoryAgentsInjectorHook`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/directory-agents-injector/index.ts#L40) in [`src/hooks/directory-agents-injector/index.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/directory-agents-injector/index.ts) and [`createDirectoryReadmeInjectorHook`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/directory-readme-injector/index.ts#L40) in [`src/hooks/directory-readme-injector/index.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/directory-readme-injector/index.ts) manage these injections for [`AGENTS.md`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L552) and [`README.md`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L45) files, respectively.
Another set of hooks addresses the challenges of running AI agents in non-interactive shell environments, such as continuous integration (CI) pipelines. The [`non-interactive-env`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L974) hook, defined in [`src/hooks/non-interactive-env/index.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/non-interactive-env/index.ts), detects if the environment is non-interactive and injects specific environment variables into shell commands. This prevents tools, particularly Git, from prompting for user input, which would otherwise cause the process to hang. The [`isNonInteractive`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/non-interactive-env/detector.ts#L1) function in [`src/hooks/non-interactive-env/detector.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/non-interactive-env/detector.ts) checks for various environment flags (e.g., [`CI`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/AGENTS.md?plain=1#L93), [`GITHUB_ACTIONS`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/non-interactive-env/detector.ts#L10)) to determine the interactivity of the environment. The [`NON_INTERACTIVE_ENV`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/non-interactive-env/constants.ts#L3) constant in [`src/hooks/non-interactive-env/constants.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/non-interactive-env/constants.ts) defines a set of environment variables that configure common tools for non-interactive operation. This hook also warns about or bans certain interactive commands that are likely to cause issues in automated contexts.
Finally, the [`compaction-context-injector`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/README.md?plain=1#L974) hook, implemented in [`src/hooks/compaction-context-injector/index.ts`](https://github.com/code-yeongyu/oh-my-opencode/blob/d0694e5aa4ecd5e0179718e190136f8b213200d9/src/hooks/compaction-context-injector/index.ts), injects a predefined prompt for summarization. This ensures that when a session's context is compacted (i.e., summarized to save tokens), the resulting summary includes critical sections such as user requests, final goals, and completed work, maintaining a structured and comprehensive overview of the session's progress. This proactive injection ensures that essential information is retained during context management, which is crucial for the [Context Window Limit Recovery](https://codewiki.google/github.com/code-yeongyu/oh-my-opencode#context-window-limit-recovery) mechanism.
