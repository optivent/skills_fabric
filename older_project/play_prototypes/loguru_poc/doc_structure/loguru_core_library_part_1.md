## Loguru Core Library
Loguru provides a simplified approach to Python logging through a single, pre-instanced [`logger`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_logger.py#L231) object. This [`logger`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_logger.py#L231), initialized in [`loguru/__init__.py`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/__init__.py) as an instance of the [`_Logger`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/__init__.py#L12) class from [`loguru/_logger.py`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_logger.py), serves as the primary interface for all logging operations. By default, it automatically directs logs to [`_sys.stderr`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/__init__.py#L31) and registers a shutdown hook to ensure proper resource release upon interpreter termination.
The library offers flexible sink configurations, allowing logs to be directed to various output targets through the [`logger.add()`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_logger.py#L963) method. Sinks can include files, standard streams ([`sys.stdout`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/README.md?plain=1#L134), [`sys.stderr`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/README.md?plain=1#L83)), custom callables, [`asyncio`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/CHANGELOG.rst#L72) coroutines, or standard [`logging.Handler`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/README.md?plain=1#L309) instances. This flexibility is managed by the [`Handler`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_handler.py#L31) class in [`loguru/_handler.py`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_handler.py), which processes log records, applies filters and formats, and dispatches them to specialized sink types such as [`StreamSink`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_simple_sinks.py#L8), [`StandardSink`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_simple_sinks.py#L53), [`AsyncSink`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_simple_sinks.py#L116), [`CallableSink`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_simple_sinks.py#L207) (all in [`loguru/_simple_sinks.py`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_simple_sinks.py)), and [`FileSink`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_file_sink.py#L164) ([`loguru/_file_sink.py`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_file_sink.py)). The [`FileSink`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_file_sink.py#L164) supports advanced features like log file rotation, retention, and compression.
For debugging, Loguru enhances exception tracebacks, providing colorized and detailed output with variable inspection. This functionality is managed by the classes within [`loguru/_better_exceptions.py`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_better_exceptions.py), which generate enhanced tracebacks, including handling chained exceptions and [`ExceptionGroup`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/CHANGELOG.rst#L33)s. To prevent logging errors from crashing the application, Loguru incorporates an [`ErrorInterceptor`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_error_interceptor.py#L5) ([`loguru/_error_interceptor.py`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_error_interceptor.py)) that catches and reports exceptions during logging operations to [`sys.stderr`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/README.md?plain=1#L83).
Log levels are configurable, allowing users to define custom levels and their associated severities, colors, and icons using the [`level`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_logger.py#L1601) method. This enables fine-grained control over which messages are processed and how they are displayed.
To ensure multiprocessing safety, Loguru offers an [`enqueue=True`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/README.md?plain=1#L142) option for sinks. When enabled, log records are placed into a [`multiprocessing.SimpleQueue`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_handler.py#L93) and processed by a separate daemon thread, decoupling the logging process from the main application thread and making it safe for concurrent execution in multiprocessing environments. The [`loguru/_locks_machinery.py`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_locks_machinery.py) file provides thread-safe lock creation for logging, managing potential deadlocks during process forking by registering fork handlers to acquire and release locks.
### Enhanced Exception Handling and Diagnostics
python
# a.py from loguru import logger import sys logger.remove() # Configure logger to output enhanced tracebacks logger.add(sys.stderr, format="", diagnose=True, backtrace=True, colorize=True) # Using @logger.catch as a decorator @logger.catch def decorated_function(): a = 1 b = 0 a / b # This will raise a ZeroDivisionError # Using logger.catch as a context manager def context_manager_example(): x = 10 y = "hello" try: # Simulate a more complex error or a chained exception raise ValueError("Initial error") except ValueError as e: with logger.catch(): # This will create a chained exception: ValueError -> TypeError z = x + y # This will raise a TypeError # Using logger.catch to wrap a function def wrapped_function(): # Simulate an ExceptionGroup (requires Python 3.11+) # Or, if older Python, simulate a simple error. if sys.version_info >= (3, 11): raise ExceptionGroup("Multiple errors", [TypeError("Type error!"), ValueError("Value error!")]) else: raise RuntimeError("A simple runtime error") # Call the functions to trigger exceptions decorated_function() context_manager_example() # Wrap the function call directly with logger.catch for immediate handling logger.catch()(wrapped_function)()
Loguru's exception handling provides enhanced tracebacks, offering more detailed and visually organized error information than standard Python outputs. These tracebacks are colorized for improved readability and include variable inspection, which displays the values of relevant variables at the point of an exception. This diagnostic capability is particularly useful for debugging complex issues by providing immediate context about the state of the program.
The system handles various exception patterns, including chained exceptions (where one exception causes another) and Python 3.11's [`ExceptionGroup`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/CHANGELOG.rst#L33)s. [`ExceptionGroup`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/CHANGELOG.rst#L33)s allow for the bundling of multiple exceptions, which Loguru can deconstruct and present in a structured, nested format, indicating relationships between different errors.
Loguru facilitates exception capture through the [`catch`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_logger.py#L1169) mechanism, which can be applied as a decorator or a context manager. This allows developers to wrap functions or blocks of code, ensuring that any exceptions raised within them are automatically logged with the enhanced traceback features.
To prevent logging-related errors from affecting the main application, Loguru incorporates an [`ErrorInterceptor`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_error_interceptor.py#L5). This component, primarily defined in [`loguru/_error_interceptor.py`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_error_interceptor.py), catches exceptions that occur within Loguru's internal logging operations (such as issues during output formatting or sink processing) and reports them to [`sys.stderr`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/README.md?plain=1#L83). This isolation mechanism ensures the robustness of the logging system, preventing it from becoming a source of application instability.
### Flexible Sink Implementation and Management
Loguru's logging architecture is built around the concept of "sinks," which are responsible for the final output of log messages. The core component for managing these sinks is the [`Handler`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_handler.py#L31) class, defined in [`loguru/_handler.py`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_handler.py). This class processes log records, applies formatting, and then dispatches them to various sink types, offering flexible output options.
The [`Handler`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_handler.py#L31) first filters log records based on level and any user-defined filter functions, as detailed in [`loguru/_filters.py`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_filters.py). It then formats the message, optionally colorizing it, and serializes it if configured. For performance, especially with dynamic formats, pre-formatted strings are cached using [`functools.lru_cache`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_handler.py#L24).
To ensure non-blocking I/O and support multiprocessing, the [`Handler`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_handler.py#L31) can enqueue log records to be processed in a separate thread or process. This asynchronous mechanism uses [`multiprocessing.SimpleQueue`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_handler.py#L93) to offload writing operations, improving application responsiveness. The [`_queued_writer`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_handler.py#L290) function, running in a daemon thread, retrieves messages from this queue and writes them to the designated sink. This design choice is particularly important for scenarios where logging to slow I/O devices might otherwise impact application performance.
Loguru provides several built-in sink implementations in [`loguru/_simple_sinks.py`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_simple_sinks.py) and [`loguru/_file_sink.py`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_file_sink.py):
* **[`StreamSink`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_simple_sinks.py#L8)**: Directs log messages to standard Python stream objects, such as[`sys.stdout`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/README.md?plain=1#L134) or [`sys.stderr`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/README.md?plain=1#L83). It can also handle flushing and closing of these streams.
* **[`StandardSink`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_simple_sinks.py#L53)**: Integrates Loguru with Python's native[`logging`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/README.md?plain=1#L297) module, allowing Loguru messages to be processed by existing [`logging.Handler`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/README.md?plain=1#L309) instances. This ensures compatibility and consistent exception formatting between the two systems.
* **[`AsyncSink`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_simple_sinks.py#L116)**: Enables asynchronous processing of log messages by invoking an[`async`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/README.md?plain=1#L139) function for each message. It manages [`asyncio`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/CHANGELOG.rst#L72) tasks, handles exceptions within these tasks, and tracks pending operations.
* **[`CallableSink`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_simple_sinks.py#L207)**: Offers a straightforward way to direct log messages to any arbitrary callable function, providing maximum flexibility for custom processing.
* **[`FileSink`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_file_sink.py#L164)**: This is a sophisticated sink, implemented in[`loguru/_file_sink.py`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_file_sink.py), designed for writing logs to files. It manages the entire lifecycle of log files, including:
* **Rotation** : Automatically creating new log files based on criteria like file size, time intervals, or specific times of day. This prevents log files from growing indefinitely.
* **Retention** : Deleting older log files based on their count or age, managing disk space effectively.
* **Compression** : Archiving rotated log files into various formats (e.g., gzip, zip) to save storage.
* **File Watching** : Detecting external changes to the log file (e.g., if it's moved or deleted by another process) and reopening it to ensure continuous logging.

The configuration for [`FileSink`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_file_sink.py#L164)'s rotation, retention, and compression features leverages a system where human-readable strings (e.g., "10 MB" for size, "1 week" for retention) are parsed and converted into callable functions. This modular approach allows for complex logging behaviors to be defined concisely.
### Contextual Logging Mechanisms
python
# Assume 'logger' is already configured, e.g., logger.add(sys.stderr, format="{message} | {extra}") # Using logger.bind() to add temporary, chained context bound_logger = logger.bind(user_id="user_123") bound_logger.info("User action completed.") # Expected output: User action completed. | {'user_id': 'user_123'} # Using logger.contextualize() for block-level context with logger.contextualize(request_id="req_456"): logger.info("Inside request context.") # Expected output: Inside request context. | {'request_id': 'req_456'} logger.info("Outside request context.") # Expected output: Outside request context. | {} # Using logger.patch() to modify the record dynamically def add_timestamp(record): import datetime record["extra"]["utc_time"] = datetime.datetime.utcnow().isoformat() patched_logger = logger.patch(add_timestamp) patched_logger.info("Patched log message.") # Expected output: Patched log message. | {'utc_time': 'YYYY-MM-DDTHH:MM:SS.ffffff'} (timestamp will vary)
Loguru provides features for enriching log messages with contextual information. These mechanisms allow for the inclusion of temporary, thread-local, or dynamically modified data within log records, making logs more informative for debugging and analysis.
The [`bind`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_logger.py#L1471) method, part of the [`Logger`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_logger.py#L231) class in [`loguru/_logger.py`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_logger.py), creates a new logger instance where all subsequent log messages automatically include specified key-value pairs in their [`extra`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/README.md?plain=1#L204) dictionary. This is useful for consistently adding common attributes, such as a request ID or user session data, to a series of log entries without repeating them in every logging call.
For managing contextual data in environments with multiple threads or asynchronous operations, Loguru offers [`contextualize`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_logger.py#L1508). This method, also part of the [`Logger`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_logger.py#L231) class in [`loguru/_logger.py`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_logger.py), acts as a context manager. Within its scope, any specified key-value pairs are added to the [`extra`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/README.md?plain=1#L204) dictionary of log records. It leverages [`contextvars`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_logger.py#L41) to ensure that this contextual information is correctly associated with the executing thread or [`asyncio`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/CHANGELOG.rst#L72) task, providing thread-safe and async-safe data enrichment.
The [`patch`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/tests/test_recattr.py#L8) method, found within the [`Logger`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_logger.py#L231) class in [`loguru/_logger.py`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/loguru/_logger.py), allows for dynamic modification of the log [`record`](https://github.com/delgan/loguru/blob/36da8cca14457f6e1d1bbca25fb29ba42b2d70cb/README.md?plain=1#L86) dictionary itself before it is sent to any handlers. By providing a callable "patcher" function, developers can inject or alter data within the record. This offers a flexible way to add complex, calculated, or conditionally derived information to log entries that might not be easily managed through simple key-value bindings.
